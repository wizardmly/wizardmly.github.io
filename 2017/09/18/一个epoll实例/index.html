<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>一个epoll实例 | 子墨不语</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">一个epoll实例</h1><a id="logo" href="/.">子墨不语</a><p class="description">路漫漫其修远兮，吾将上下而求索</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">一个epoll实例</h1><div class="post-meta">Sep 18, 2017<span> | </span><span class="category"><a href="/categories/学习笔记/">学习笔记</a></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#epoll在Android中的应用"><span class="toc-number">1.</span> <span class="toc-text">epoll在Android中的应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实例代码（采用epoll-pipe实现）"><span class="toc-number">2.</span> <span class="toc-text">实例代码（采用epoll + pipe实现）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#改用epoll-eventfd来实现"><span class="toc-number">3.</span> <span class="toc-text">改用epoll + eventfd来实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考链接"><span class="toc-number">4.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div><div class="post-content"><p>epoll 于Linux 2.5.44引入，旨在替换select和poll系统函数。</p>
<p>相对于select和poll来说，epoll更加灵活高效:</p>
<ul>
<li>没有监视描述符数量单进程1024限制</li>
<li>epoll使用一个文件描述符管理多个描述符，将用户关系的文件描述符的事件存放到内核的一个事件表中，这样在用户空间和内核空间的copy只需一次。</li>
</ul>
<h2 id="epoll在Android中的应用"><a href="#epoll在Android中的应用" class="headerlink" title="epoll在Android中的应用"></a>epoll在Android中的应用</h2><p>epoll机制在Android系统中扮演着一个很重要的角色，</p>
<ol>
<li>在MessageQueue的队列中，当队列为空时需要阻塞Looper线程，队列非空时候需要唤醒线程，使用到了epoll + eventfd(比pipe更高效的事件驱动，在<a href="https://android.googlesource.com/platform/system/core/+/8892ce6%5E!/" target="_blank" rel="external">6.0引入</a>)机制，高效的管理着消息队列</li>
<li>java NIO中 Selector采用了epoll机制实现SocketChannel管道事件轮询</li>
</ol>
<h2 id="实例代码（采用epoll-pipe实现）"><a href="#实例代码（采用epoll-pipe实现）" class="headerlink" title="实例代码（采用epoll + pipe实现）"></a>实例代码（采用epoll + pipe实现）</h2><p>本例我们采用 epoll + pipe的机制，简单的模拟一个通信唤醒的场景来理解epoll通信，更深入的理解，可以阅读libevent源码</p>
<ol>
<li>创建管道</li>
<li>创建epll事件：并设置关注的事件类型</li>
<li>创建epoll</li>
<li>往epoll注册事件</li>
<li>fork一个子进程，sleep(3)秒后，往管道写入数据</li>
<li>父进程挂起，监听事件源(管道读取端fd)事件</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//最大事件数</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> MAXEVENTS = <span class="number">1024</span>;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 1. 创建管道，并将管道两端的fd存放在数组pipe_fd中</span></div><div class="line"><span class="comment">     * pipe_fd[0] ： 管道输出端，可读取fd</span></div><div class="line"><span class="comment">     * pipe_fd[1] ： 管道输入端，可写入fd</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</div><div class="line">    <span class="keyword">if</span> ((ret = pipe(pipe_fd)) &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"create pipe fail:"</span> &lt;&lt; ret &lt;&lt; <span class="string">",errno:"</span> &lt;&lt; errno &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 2. 创建epoll关注事件源的事件类型</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">ev</span>;</span></div><div class="line">    <span class="comment">//设置监听事件源</span></div><div class="line">    ev.data.fd = pipe_fd[<span class="number">0</span>];</div><div class="line">    <span class="comment">//设置监听什么事件：EPOLLIN, 事件源可读事件， EPOLLET 边缘触发模式(Edge Triggered)</span></div><div class="line">    ev.events = EPOLLIN | EPOLLET;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 3. 创建epoll对象，返回epoll对象的fd地址</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">int</span> epfd = epoll_create(MAXEVENTS);</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 4. 往epoll对象中 添加/修改/删除 一个事件(事件源fd, 事件类型&amp;ev)</span></div><div class="line"><span class="comment">     * EPOLL_CTL_ADD：注册新的fd到epfd中；</span></div><div class="line"><span class="comment">     * EPOLL_CTL_MOD：修改已经注册的fd的监听事件；</span></div><div class="line"><span class="comment">     * EPOLL_CTL_DEL：从epfd中删除一个fd；</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    ret = epoll_ctl(epfd, EPOLL_CTL_ADD, pipe_fd[<span class="number">0</span>], &amp;ev);</div><div class="line">    <span class="comment">//校验</span></div><div class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"epoll_ctl fail:"</span> &lt;&lt; ret &lt;&lt; <span class="string">",errno:"</span> &lt;&lt; errno &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        close(pipe_fd[<span class="number">0</span>]);</div><div class="line">        close(pipe_fd[<span class="number">1</span>]);</div><div class="line">        close(epfd);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//fork一个进程，来读取epoll事件</span></div><div class="line">    <span class="keyword">int</span> pid = fork();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;<span class="comment">//父进程</span></div><div class="line">        <span class="comment">//监听事件数组</span></div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">events</span>[<span class="title">MAXEVENTS</span>];</span></div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 6. 使用epoll，开始监听事件，并将事件放置到数组events中</span></div><div class="line"><span class="comment">         *</span></div><div class="line"><span class="comment">         * epoll_wait会阻塞当前线程，当监听的事件发生的时候，会唤醒该线程</span></div><div class="line"><span class="comment">         *</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keyword">int</span> count = epoll_wait(epfd, events, MAXEVENTS, <span class="number">5000</span>);</div><div class="line">        <span class="keyword">char</span> r_buf[<span class="number">100</span>];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">            <span class="comment">//校验</span></div><div class="line">            <span class="keyword">if</span> ((events[i].data.fd == pipe_fd[<span class="number">0</span>]) &amp;&amp; (events[<span class="number">0</span>].events &amp; EPOLLIN)) &#123;</div><div class="line">                <span class="keyword">int</span> r_num = read(pipe_fd[<span class="number">0</span>], r_buf, <span class="number">100</span>);</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"parrent read num is %d bytes data from the pipe, value is %d \n"</span>, r_num, atoi(r_buf));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        close(pipe_fd[<span class="number">1</span>]);</div><div class="line">        close(pipe_fd[<span class="number">0</span>]);</div><div class="line">        close(epfd);</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"parent close read fd[0], wirte fd[1] and epfd over"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;<span class="comment">//子进程</span></div><div class="line">        <span class="comment">//子进程不进行读取操作，关闭读取fd</span></div><div class="line">        close(pipe_fd[<span class="number">0</span>]);<span class="comment">//read</span></div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"sub does't read, so close read fd[0], over"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">        <span class="comment">//当前线程睡眠3秒</span></div><div class="line">        sleep(<span class="number">3</span>);</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 5. 子进程开始向管道写入数据，触发EPOLLIN事件</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keyword">char</span> w_buf[<span class="number">100</span>];</div><div class="line">        <span class="built_in">strcpy</span>(w_buf, <span class="string">"1234"</span>);</div><div class="line">        <span class="keyword">if</span> (write(pipe_fd[<span class="number">1</span>], w_buf, <span class="number">5</span>) != <span class="number">-1</span>)<span class="comment">//you can remove this line for learn</span></div><div class="line">            <span class="built_in">printf</span>(<span class="string">"sub write write num 1234, over \n"</span>);</div><div class="line">        <span class="comment">//关闭写入端管道fd</span></div><div class="line">        close(pipe_fd[<span class="number">1</span>]);<span class="comment">//write</span></div><div class="line">        <span class="built_in">printf</span>(<span class="string">"sub close write fd[1] over \n"</span>);</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//pid&lt;0, fork error</span></div><div class="line">        close(pipe_fd[<span class="number">0</span>]);</div><div class="line">        close(pipe_fd[<span class="number">1</span>]);</div><div class="line">        close(epfd);</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"fork error:"</span> &lt;&lt; pid &lt;&lt; <span class="string">", close fds over"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="改用epoll-eventfd来实现"><a href="#改用epoll-eventfd来实现" class="headerlink" title="改用epoll + eventfd来实现"></a>改用epoll + eventfd来实现</h2><p>eventfd在2.6.22引入，是比pipe更高效的线程间事件通知机制，它的缓冲区只有8个字节。</p>
<p>eventfd 只能用于线程间、父子进程间的通信</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// Created by milo on 17-9-18.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/eventfd.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> MAXEVENTS = <span class="number">1024</span>;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * eventfd (unsigned int __count, int __flags)</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * man: http://man7.org/linux/man-pages/man2/eventfd.2.html</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * initval: eventfd设备初始值</span></div><div class="line"><span class="comment">     * flags: 在2.6.26之前的版本，必须设置为0，之后的版本有以下值：</span></div><div class="line"><span class="comment">     *     EFD_SEMAPHORE</span></div><div class="line"><span class="comment">     *     EFD_CLOEXEC</span></div><div class="line"><span class="comment">     *     EFD_NONBLOCK</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">int</span> efd = eventfd(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 1. 创建epoll关注事件源的事件类型</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">ev</span>;</span></div><div class="line">    <span class="comment">//设置监听事件源</span></div><div class="line">    ev.data.fd = efd;</div><div class="line">    <span class="comment">//设置监听什么事件：EPOLLIN, 事件源可读事件， EPOLLET 边缘触发模式(Edge Triggered)</span></div><div class="line">    ev.events = EPOLLIN | EPOLLET;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 2. 创建epoll对象，返回epoll对象的fd地址</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">int</span> epfd = epoll_create(MAXEVENTS);</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 3. 往epoll对象中 添加/修改/删除 一个事件(事件源fd, 事件类型&amp;ev)</span></div><div class="line"><span class="comment">     * EPOLL_CTL_ADD：注册新的fd到epfd中；</span></div><div class="line"><span class="comment">     * EPOLL_CTL_MOD：修改已经注册的fd的监听事件；</span></div><div class="line"><span class="comment">     * EPOLL_CTL_DEL：从epfd中删除一个fd；</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    ret = epoll_ctl(epfd, EPOLL_CTL_ADD, efd, &amp;ev);</div><div class="line">    <span class="comment">//校验</span></div><div class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"epoll_ctl fail:"</span> &lt;&lt; ret &lt;&lt; <span class="string">",errno:"</span> &lt;&lt; errno &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        close(efd);</div><div class="line">        close(epfd);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//fork一个进程，来读取epoll事件</span></div><div class="line">    <span class="keyword">int</span> pid = fork();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;<span class="comment">//父进程</span></div><div class="line">        <span class="comment">//监听事件数组</span></div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">events</span>[<span class="title">MAXEVENTS</span>];</span></div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 4. 使用epoll，开始监听事件源，并将事件放置到数组events中</span></div><div class="line"><span class="comment">         *</span></div><div class="line"><span class="comment">         * epoll_wait会阻塞当前线程，当监听的事件发生的时候，会唤醒该线程</span></div><div class="line"><span class="comment">         *</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keyword">int</span> count = epoll_wait(epfd, events, MAXEVENTS, <span class="number">5000</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">            <span class="comment">//校验</span></div><div class="line">            <span class="keyword">if</span> ((events[i].data.fd == efd) &amp;&amp; (events[<span class="number">0</span>].events &amp; EPOLLIN)) &#123;</div><div class="line">                <span class="keyword">eventfd_t</span> r_num;</div><div class="line">                <span class="keyword">ssize_t</span> size = read(efd, &amp;r_num, <span class="keyword">sizeof</span>(<span class="keyword">eventfd_t</span>));</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"parrent read num is %d bytes data from the eventfd, value is %d \n"</span>, size, r_num);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        close(efd);</div><div class="line">        close(epfd);</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"parent close eventfd and epfd over"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;<span class="comment">//子进程</span></div><div class="line">        <span class="built_in">printf</span>(<span class="string">"sub sleep 3 senconds, and then write\n"</span>);</div><div class="line">        flush(<span class="built_in">cout</span>);</div><div class="line">        <span class="comment">//当前线程睡眠3秒</span></div><div class="line">        sleep(<span class="number">3</span>);</div><div class="line"></div><div class="line">        <span class="comment">//子进程开始向eventfd设备写入数据</span></div><div class="line">        <span class="keyword">eventfd_t</span> num = <span class="number">18</span>;</div><div class="line">        <span class="keyword">if</span> (write(efd, &amp;num, <span class="keyword">sizeof</span>(<span class="keyword">eventfd_t</span>)) == <span class="keyword">sizeof</span>(<span class="keyword">eventfd_t</span>))<span class="comment">//you can remove this line for learn</span></div><div class="line">            <span class="built_in">printf</span>(<span class="string">"sub write num %d, over \n"</span>, num);</div><div class="line">        <span class="comment">//关闭子进程eventfd</span></div><div class="line">        close(efd);<span class="comment">//write</span></div><div class="line">        <span class="built_in">printf</span>(<span class="string">"sub close write eventfd over \n"</span>);</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//pid&lt;0, fork error</span></div><div class="line">        close(efd);</div><div class="line">        close(epfd);</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"fork error:"</span> &lt;&lt; pid &lt;&lt; <span class="string">", close fds over"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://aceld.gitbooks.io/libevent/content/" target="_blank" rel="external">Libevent深入浅出</a><br><br><a href="http://blog.csdn.net/u010657219/article/details/44061629" target="_blank" rel="external">实现机制详解</a><br><br><a href="http://www.cnblogs.com/Anker/p/3263780.html" target="_blank" rel="external">IO多路复用之epoll总结</a><br><br><a href="http://yaocoder.blog.51cto.com/2668309/888374" target="_blank" rel="external">我读过的最好的epoll讲解–转自”知乎“</a><br><br><a href="http://man7.org/linux/man-pages/man2/eventfd.2.html" target="_blank" rel="external">man2:eventfd</a></p>
</div><div class="tags"><a href="/tags/Linux/">Linux</a><a href="/tags/C-C/">C/C++</a></div><div class="post-nav"><a href="/2017/09/25/Android源码阅读技巧/" class="pre">Android源码阅读准备</a><a href="/2017/09/17/本博客的建立/" class="next">本博客的建立</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.molingyu.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/学习笔记/">学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/源码阅读/" style="font-size: 15px;">源码阅读</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/前端/" style="font-size: 15px;">前端</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/10/由DBUtils使用ResultHandler引出的一个关于JavaBean反射的问题/">由DBUtils使用ResultHandler引出的一个关于JavaBean反射的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/09/前端学习笔记_JavaScript学习(一)/">前端学习笔记_JavaScript学习（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/27/Android启动源码阅读(三)systemserver的启动过程/">Android启动源码阅读(三)systemserver进程的启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/27/Android启动源码阅读(二)zygote进程的启动/">Android启动源码阅读(二)zygote进程的启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/26/Android启动源码阅读(一)init进程的启动/">Android启动源码阅读(一)init进程的启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/25/Android源码阅读技巧/">Android源码阅读准备</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/18/一个epoll实例/">一个epoll实例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/17/本博客的建立/">本博客的建立</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/17/ReentrantLock/">ReentrantLock</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/JakeWharton" title="JakeWharton" target="_blank">JakeWharton</a><ul></ul><a href="https://github.com/Trinea" title="Trinea" target="_blank">Trinea</a><ul></ul><a href="http://blog.csdn.net/luoshengyang" title="罗升阳" target="_blank">罗升阳</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">子墨.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Maupassant</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>