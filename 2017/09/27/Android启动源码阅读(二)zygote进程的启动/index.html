<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Android启动源码阅读(二)zygote进程的启动 | 子墨不语</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android启动源码阅读(二)zygote进程的启动</h1><a id="logo" href="/.">子墨不语</a><p class="description">路漫漫其修远兮，吾将上下而求索</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Android启动源码阅读(二)zygote进程的启动</h1><div class="post-meta">Sep 27, 2017<span> | </span><span class="category"><a href="/categories/学习笔记/">学习笔记</a></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#开始阅读-app-main-cpp-gt-main-方法"><span class="toc-number">1.</span> <span class="toc-text">开始阅读:app_main.cpp -> main()方法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AppRuntime-gt-start-方法"><span class="toc-number">2.</span> <span class="toc-text">AppRuntime->start()方法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#启动虚拟机之后，进入Java世界-ZygoteInit-main"><span class="toc-number">3.</span> <span class="toc-text">启动虚拟机之后，进入Java世界: ZygoteInit.main()</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-registerZygoteSocket"><span class="toc-number">3.1.</span> <span class="toc-text">1. registerZygoteSocket()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-startSystemServer"><span class="toc-number">3.2.</span> <span class="toc-text">2. startSystemServer()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-runSelectLoop"><span class="toc-number">3.3.</span> <span class="toc-text">3. runSelectLoop()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#调用ZygoteConnection-runOnce-处理请求"><span class="toc-number">3.3.1.</span> <span class="toc-text">调用ZygoteConnection.runOnce()处理请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#handleChildProc-与-handleParentProc"><span class="toc-number">3.3.2.</span> <span class="toc-text">handleChildProc 与 handleParentProc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RuntimeInit-zygoteInit"><span class="toc-number">3.3.3.</span> <span class="toc-text">RuntimeInit.zygoteInit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RuntimeInit-applicationInit"><span class="toc-number">3.3.4.</span> <span class="toc-text">RuntimeInit.applicationInit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RuntimeInit-invokeStaticMain"><span class="toc-number">3.3.5.</span> <span class="toc-text">RuntimeInit.invokeStaticMain</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#完结"><span class="toc-number">4.</span> <span class="toc-text">完结</span></a></li></ol></div></div><div class="post-content"><p>从上一篇<a href="http://molingyu.com/2017/09/26/Android%E5%90%AF%E5%8A%A8%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%B8%80)init%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%90%AF%E5%8A%A8/" target="_blank" rel="external">init的启动</a>可以看到，zygote由init进程解析init.zygoteXXX.rc文件，然后fork进程，并为zygote进程创建了/dev/socket/zygote的socket接口，然后创建zygote进程，执行/system/bin/app_process，传入参数：-Xzygote /system/bin –zygote –start-system-server</p>
<p>本文，我们看下app_process干了些什么事情</p>
<p>仍然是AndroidStudio查找源码的流程：</p>
<ol>
<li>Ctrl + Shift + F 全局查找字符串 <em>:= app_process</em></li>
<li>找到Android.mk文件：frameworks/base/cmds/app_process/Android.mk</li>
<li>对应的LOCAL_SRC_FILES:= \app_main.cpp，因此app_process的源码位于frameworks/base/cmds/app_process/app_main.cpp中</li>
</ol>
<h1 id="开始阅读-app-main-cpp-gt-main-方法"><a href="#开始阅读-app-main-cpp-gt-main-方法" class="headerlink" title="开始阅读:app_main.cpp -&gt; main()方法"></a>开始阅读:app_main.cpp -&gt; main()方法</h1><p>记住，在init在执行的时候，入参是:-Xzygote /system/bin –zygote –start-system-server，解析得到的args = {“-Xzygote” “/system/bin”，”-zygote“， ”-start-system-server“}，携带这些参数，我们来看下main方法的执行情况</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//使用argv[0]参数进行</span></div><div class="line">AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv));</div><div class="line"><span class="comment">// Process command line arguments</span></div><div class="line"><span class="comment">// ignore argv[0], 忽略argv[0]参数</span></div><div class="line"><span class="comment">//argc-1 = 3</span></div><div class="line">argc--;</div><div class="line"><span class="comment">//argv++，即数组头指针后移一个位置</span></div><div class="line">argv++;</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line"><span class="keyword">int</span> i;</div><div class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc; i++) &#123;</div><div class="line">    <span class="comment">//如果参数不是以'-'开头，直接跳出循环</span></div><div class="line">    <span class="keyword">if</span> (argv[i][<span class="number">0</span>] != <span class="string">'-'</span>) &#123;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//如果参数第二个字符为'-'并且第三个字符为截止字符，则忽略，并跳出循环</span></div><div class="line">    <span class="keyword">if</span> (argv[i][<span class="number">1</span>] == <span class="string">'-'</span> &amp;&amp; argv[i][<span class="number">2</span>] == <span class="number">0</span>) &#123;</div><div class="line">        ++i; <span class="comment">// Skip --.</span></div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//为runtime添加参数</span></div><div class="line">    runtime.addOption(strdup(argv[i]));</div><div class="line">&#125;</div><div class="line"><span class="comment">//因此，因为此前的argv++，故而argv[0]="/syste/bin"，故而跳出上述循环，此时i = 0</span></div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line"><span class="comment">//++i，跳过了第一个参数/system/bin，即跳过父目录参数</span></div><div class="line">++i;  <span class="comment">// Skip unused "parent dir" argument.</span></div><div class="line"><span class="comment">//继续执行</span></div><div class="line"><span class="keyword">while</span> (i &lt; argc) &#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* arg = argv[i++];</div><div class="line">    <span class="comment">//i = 1, argv[1] = "--zygote"， 然后i++</span></div><div class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--zygote"</span>) == <span class="number">0</span>) &#123;</div><div class="line">        zygote = <span class="literal">true</span>;</div><div class="line">        niceName = ZYGOTE_NICE_NAME;</div><div class="line">    <span class="comment">//i = 1, argv[2] = "-start-system-server"， 然后i++=3 = argc，跳出循环</span></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--start-system-server"</span>) == <span class="number">0</span>) &#123;</div><div class="line">        startSystemServer = <span class="literal">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--application"</span>) == <span class="number">0</span>) &#123;</div><div class="line">        application = <span class="literal">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--nice-name="</span>, <span class="number">12</span>) == <span class="number">0</span>) &#123;</div><div class="line">        niceName.setTo(arg + <span class="number">12</span>);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--"</span>, <span class="number">2</span>) != <span class="number">0</span>) &#123;</div><div class="line">        className.setTo(arg);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        --i;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//因此上述while做了几个事情：</span></div><div class="line"><span class="comment">//1. zygote = true;</span></div><div class="line"><span class="comment">//2. niceName = ZYGOTE_NICE_NAME; // zygote或者zygote64</span></div><div class="line"><span class="comment">//3. startSystemServer = true;</span></div><div class="line"></div><div class="line"><span class="comment">//下面代码的注释已经比较清除了，args是runtime.start(）要传入的参数之一</span></div><div class="line">Vector&lt;String8&gt; args;</div><div class="line"><span class="keyword">if</span> (!className.isEmpty()) &#123;</div><div class="line">    <span class="comment">// We're not in zygote mode, the only argument we need to pass</span></div><div class="line">    <span class="comment">// to RuntimeInit is the application argument.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// The Remainder of args get passed to startup class main(). Make</span></div><div class="line">    <span class="comment">// copies of them before we overwrite them with the process name.</span></div><div class="line">    args.add(application ? String8(<span class="string">"application"</span>) : String8(<span class="string">"tool"</span>));</div><div class="line">    runtime.setClassNameAndArgs(className, argc - i, argv + i);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// We're in zygote mode.</span></div><div class="line">    maybeCreateDalvikCache();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (startSystemServer) &#123;</div><div class="line">        args.add(String8(<span class="string">"start-system-server"</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">char</span> prop[PROP_VALUE_MAX];</div><div class="line">    <span class="keyword">if</span> (property_get(ABI_LIST_PROPERTY, prop, <span class="literal">NULL</span>) == <span class="number">0</span>) &#123;</div><div class="line">        LOG_ALWAYS_FATAL(<span class="string">"app_process: Unable to determine ABI list from property %s."</span>,</div><div class="line">            ABI_LIST_PROPERTY);</div><div class="line">        <span class="keyword">return</span> <span class="number">11</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function">String8 <span class="title">abiFlag</span><span class="params">(<span class="string">"--abi-list="</span>)</span></span>;</div><div class="line">    abiFlag.append(prop);</div><div class="line">    args.add(abiFlag);</div><div class="line"></div><div class="line">    <span class="comment">// In zygote mode, pass all remaining arguments to the zygote</span></div><div class="line">    <span class="comment">// main() method.</span></div><div class="line">    <span class="keyword">for</span> (; i &lt; argc; ++i) &#123;</div><div class="line">        args.add(String8(argv[i]));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//设置进程名称</span></div><div class="line"><span class="keyword">if</span> (!niceName.isEmpty()) &#123;</div><div class="line">    runtime.setArgv0(niceName.<span class="built_in">string</span>());</div><div class="line">    set_process_name(niceName.<span class="built_in">string</span>());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (zygote) &#123;</div><div class="line">    <span class="comment">//进入AppRuntime.start方法</span></div><div class="line">    runtime.start(<span class="string">"com.android.internal.os.ZygoteInit"</span>, args, zygote);</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</div><div class="line">    runtime.start(<span class="string">"com.android.internal.os.RuntimeInit"</span>, args, zygote);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error: no class name or --zygote supplied.\n"</span>);</div><div class="line">    app_usage();</div><div class="line">    LOG_ALWAYS_FATAL(<span class="string">"app_process: no class name or --zygote supplied."</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">10</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="AppRuntime-gt-start-方法"><a href="#AppRuntime-gt-start-方法" class="headerlink" title="AppRuntime-&gt;start()方法"></a>AppRuntime-&gt;start()方法</h1><p>AppRuntime的定义在app_main.cpp中，继承于AndroidRuntime类，类文件位于frameworks/base/core/jni/AndroidRuntime.cpp，头文件位于frameworks/base/include/android_runtime/AndroidRuntime.h</p>
<p>而AppRuntime主要重写了几个方法：</p>
<ul>
<li>onVmCreated</li>
<li>onStarted</li>
<li>onZygoteInit</li>
<li>onExit</li>
<li>并定义了方法setClassNameAndArgs</li>
<li>新增了几个成员：String8 mClassName, Vector<string8> mArgs, jclass mClass;</string8></li>
</ul>
<p>start方法位于AndroidRuntime中定义，我们来看看：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> AndroidRuntime::start(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> Vector&lt;String8&gt;&amp; options, <span class="keyword">bool</span> zygote)</div><div class="line">&#123;</div><div class="line">  <span class="comment">//startSystemServer = "start-system-server"</span></div><div class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">const</span> String8 <span class="title">startSystemServer</span><span class="params">(<span class="string">"start-system-server"</span>)</span></span>;</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">  <span class="comment">//将rootDir设置为"/system"</span></div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* rootDir = getenv(<span class="string">"ANDROID_ROOT"</span>);</div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment">//1. 启动虚拟机</span></div><div class="line">  <span class="comment">/* start the virtual machine */</span></div><div class="line">  JniInvocation jni_invocation;</div><div class="line">  jni_invocation.Init(<span class="literal">NULL</span>);</div><div class="line">  JNIEnv* env;  <span class="comment">//虚拟机环境指针</span></div><div class="line">  <span class="keyword">if</span> (startVm(&amp;mJavaVM, &amp;env, zygote) != <span class="number">0</span>) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  onVmCreated(env);</div><div class="line">  </div><div class="line">  <span class="comment">//注册jni函数</span></div><div class="line">  <span class="comment">/*</span></div><div class="line"><span class="comment">   * Register android functions.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">if</span> (startReg(env) &lt; <span class="number">0</span>) &#123;</div><div class="line">      ALOGE(<span class="string">"Unable to register all android natives\n"</span>);</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line"><span class="comment">   * We want to call main() with a String array with arguments in it.</span></div><div class="line"><span class="comment">   * At present we have two arguments, the class name and an option string.</span></div><div class="line"><span class="comment">   * Create an array to hold them.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  jclass stringClass;</div><div class="line">  jobjectArray strArray;</div><div class="line">  jstring classNameStr;</div><div class="line"></div><div class="line">  stringClass = env-&gt;FindClass(<span class="string">"java/lang/String"</span>);</div><div class="line">  assert(stringClass != <span class="literal">NULL</span>);</div><div class="line">  strArray = env-&gt;NewObjectArray(options.size() + <span class="number">1</span>, stringClass, <span class="literal">NULL</span>);</div><div class="line">  assert(strArray != <span class="literal">NULL</span>);</div><div class="line">  classNameStr = env-&gt;NewStringUTF(className);</div><div class="line">  assert(classNameStr != <span class="literal">NULL</span>);</div><div class="line">  env-&gt;SetObjectArrayElement(strArray, <span class="number">0</span>, classNameStr);</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</div><div class="line">      jstring optionsStr = env-&gt;NewStringUTF(options.itemAt(i).<span class="built_in">string</span>());</div><div class="line">      assert(optionsStr != <span class="literal">NULL</span>);</div><div class="line">      env-&gt;SetObjectArrayElement(strArray, i + <span class="number">1</span>, optionsStr);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line"><span class="comment">   * Start VM.</span></div><div class="line"><span class="comment">   * 注意以下两点</span></div><div class="line"><span class="comment">   * 1. This thread becomes the main thread of the VM, </span></div><div class="line"><span class="comment">   * 2. and will not return until the VM exits.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">char</span>* slashClassName = toSlashClassName(className);</div><div class="line">  <span class="comment">//找到class字节码实例：com.android.internal.os.ZygoteInit.class</span></div><div class="line">  jclass startClass = env-&gt;FindClass(slashClassName);</div><div class="line">  <span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</div><div class="line">      ALOGE(<span class="string">"JavaVM unable to locate class '%s'\n"</span>, slashClassName);</div><div class="line">      <span class="comment">/* keep going */</span></div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">//找到main函数</span></div><div class="line">      jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="string">"main"</span>, <span class="string">"([Ljava/lang/String;)V"</span>);</div><div class="line">      <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</div><div class="line">          ALOGE(<span class="string">"JavaVM unable to find main() in '%s'\n"</span>, className);</div><div class="line">          <span class="comment">/* keep going */</span></div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="comment">//调用main函数，进入ZygoteInit.main()中，直到main函数退出（此时虚拟机也会退出）</span></div><div class="line">          env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></div><div class="line">          <span class="comment">//未正常退出</span></div><div class="line">          <span class="keyword">if</span> (env-&gt;ExceptionCheck())</div><div class="line">              threadExitUncaughtException(env);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="built_in">free</span>(slashClassName);</div><div class="line">  <span class="comment">//虚拟机退出</span></div><div class="line">  ALOGD(<span class="string">"Shutting down VM\n"</span>);</div><div class="line">  <span class="keyword">if</span> (mJavaVM-&gt;DetachCurrentThread() != JNI_OK)</div><div class="line">      ALOGW(<span class="string">"Warning: unable to detach main thread\n"</span>);</div><div class="line">  <span class="keyword">if</span> (mJavaVM-&gt;DestroyJavaVM() != <span class="number">0</span>)</div><div class="line">      ALOGW(<span class="string">"Warning: VM did not shut down cleanly\n"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li>startVm(): 一系列的虚拟机环境参数配置，最终调用JNI_CreateJavaVM初始化虚拟机，如果方法调用成功，则虚拟机准备完毕，这部分是dalvikVm的知识，以后再研究</li>
<li>startReg(): 主要通过register_jni_procs来注册jni函数，如register_com_android_internal_os_RuntimeInit、register_android_opengl<em>jni</em>…等等jni library</li>
</ul>
<h1 id="启动虚拟机之后，进入Java世界-ZygoteInit-main"><a href="#启动虚拟机之后，进入Java世界-ZygoteInit-main" class="headerlink" title="启动虚拟机之后，进入Java世界: ZygoteInit.main()"></a>启动虚拟机之后，进入Java世界: ZygoteInit.main()</h1><p>还是来看代码, </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</div><div class="line">  <span class="comment">// Mark zygote start. This ensures that thread creation will throw</span></div><div class="line">  <span class="comment">// an error.</span></div><div class="line">  ZygoteHooks.startZygoteNoThreadCreation();</div><div class="line"></div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      <span class="comment">//调试相关</span></div><div class="line">      Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"ZygoteInit"</span>);</div><div class="line">      /开启ddms</div><div class="line">      RuntimeInit.enableDdms();</div><div class="line">      <span class="comment">// Start profiling the zygote initialization.</span></div><div class="line">      SamplingProfilerIntegration.start();</div><div class="line">      </div><div class="line">      </div><div class="line">      boolean startSystemServer = <span class="literal">false</span>;</div><div class="line">      String socketName = <span class="string">"zygote"</span>;</div><div class="line">      String abiList = null;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argv.length; i++) &#123;</div><div class="line">          <span class="comment">//是否需要启动systemserver: zygote进程启动时候，true</span></div><div class="line">          <span class="keyword">if</span> (<span class="string">"start-system-server"</span>.equals(argv[i])) &#123;</div><div class="line">              startSystemServer = <span class="literal">true</span>;</div><div class="line">          <span class="comment">//是否包含abilist，zygote进程，true</span></div><div class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;</div><div class="line">              abiList = argv[i].substring(ABI_LIST_ARG.length());</div><div class="line">          <span class="comment">//是否包含socketname，zygote进程，true</span></div><div class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</div><div class="line">              socketName = argv[i].substring(SOCKET_NAME_ARG.length());</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unknown command line argument: "</span> + argv[i]);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (abiList == null) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No ABI list supplied."</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="comment">//注册zygote的socket服务端接口</span></div><div class="line">      registerZygoteSocket(socketName);</div><div class="line">      Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"ZygotePreload"</span>);</div><div class="line">      EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,</div><div class="line">          SystemClock.uptimeMillis());</div><div class="line">      <span class="comment">//预加载：类、资源、opengl已经共享库等等，这样在fork一个新的进程的时，就不再需要重新加载这些资源</span></div><div class="line">      <span class="comment">//而由于linux的fork机制，这些预加载的资源，除非有修改需求，否则都共享父进程的同一个资源</span></div><div class="line">      preload();</div><div class="line">      EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,</div><div class="line">          SystemClock.uptimeMillis());</div><div class="line">      Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line"></div><div class="line">      <span class="comment">// Finish profiling the zygote initialization.</span></div><div class="line">      SamplingProfilerIntegration.writeZygoteSnapshot();</div><div class="line"></div><div class="line">      <span class="comment">// Do an initial gc to clean up after startup</span></div><div class="line">      Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"PostZygoteInitGC"</span>);</div><div class="line">      <span class="comment">//进行依次gc回收</span></div><div class="line">      gcAndFinalize();</div><div class="line">      Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line"></div><div class="line">      Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line"></div><div class="line">      <span class="comment">// Disable tracing so that forked processes do not inherit stale tracing tags from</span></div><div class="line">      <span class="comment">// Zygote.</span></div><div class="line">      Trace.setTracingEnabled(<span class="literal">false</span>);</div><div class="line"></div><div class="line">      <span class="comment">// Zygote process unmounts root storage spaces.</span></div><div class="line">      Zygote.nativeUnmountStorageOnInit();</div><div class="line"></div><div class="line">      ZygoteHooks.stopZygoteNoThreadCreation();</div><div class="line">      </div><div class="line">      <span class="comment">//启动SystemServer进程</span></div><div class="line">      <span class="keyword">if</span> (startSystemServer) &#123;</div><div class="line">          startSystemServer(abiList, socketName);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      Log.i(TAG, <span class="string">"Accepting command socket connections"</span>);</div><div class="line">      <span class="comment">//进入select loop循环</span></div><div class="line">      runSelectLoop(abiList);</div><div class="line">      <span class="comment">//关闭服务端server socket</span></div><div class="line">      closeServerSocket();</div><div class="line">  &#125; <span class="keyword">catch</span> (MethodAndArgsCaller caller) &#123;</div><div class="line">      <span class="comment">//caller.run()</span></div><div class="line">      caller.run();</div><div class="line">  &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">      Log.e(TAG, <span class="string">"Zygote died with exception"</span>, ex);</div><div class="line">      closeServerSocket();</div><div class="line">      <span class="keyword">throw</span> ex;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>小结，ZygoteInit.main()主要做了几件事情：</p>
<ol>
<li>registerZygoteSocket，注册zygote的socket服务，等待其他client的请求</li>
<li>startSystemServer开启systemserver进程，这是java世界的基石：包含了众多的服务，如AMS, WMS，IMS等等</li>
<li>调用runSelectLoop，进入无限循环，等待client请求，来创建进程，每创建一个进程，在子进程中都会抛出异常MethodAndArgsCaller，从而子进程中的代码会运行到caller.run()方法中去</li>
</ol>
<h2 id="1-registerZygoteSocket"><a href="#1-registerZygoteSocket" class="headerlink" title="1. registerZygoteSocket()"></a>1. registerZygoteSocket()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//入参是"zygote"</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerZygoteSocket</span><span class="params">(String socketName)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (sServerSocket == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">int</span> fileDesc;</div><div class="line">        <span class="comment">//由于zygote进程创建的时候，会创建名为zygote的socket节点的fd，并将节点设置到环境变量ANDROID_SOCKET_zygote中去</span></div><div class="line">        <span class="keyword">final</span> String fullSocketName = ANDROID_SOCKET_PREFIX + socketName;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            String env = System.getenv(fullSocketName);</div><div class="line">            fileDesc = Integer.parseInt(env);</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(fullSocketName + <span class="string">" unset or invalid"</span>, ex);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            FileDescriptor fd = <span class="keyword">new</span> FileDescriptor();</div><div class="line">            fd.setInt$(fileDesc);</div><div class="line">            <span class="comment">//创建socket的server端</span></div><div class="line">            sServerSocket = <span class="keyword">new</span> LocalServerSocket(fd);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                    <span class="string">"Error binding to local socket '"</span> + fileDesc + <span class="string">"'"</span>, ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-startSystemServer"><a href="#2-startSystemServer" class="headerlink" title="2. startSystemServer()"></a>2. startSystemServer()</h2><p>另外开一篇文章来写吧，这里我们记住，system_server进程，由zygote进程fork出来，然后在创建的虚拟机中执行SystemServer.main()方法</p>
<h2 id="3-runSelectLoop"><a href="#3-runSelectLoop" class="headerlink" title="3. runSelectLoop()"></a>3. runSelectLoop()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runSelectLoop</span><span class="params">(String abiList)</span> <span class="keyword">throws</span> MethodAndArgsCaller </span>&#123;</div><div class="line">    <span class="comment">//fds和peers一一对应</span></div><div class="line">    ArrayList&lt;FileDescriptor&gt; fds = <span class="keyword">new</span> ArrayList&lt;FileDescriptor&gt;();</div><div class="line">    ArrayList&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();</div><div class="line">    </div><div class="line">    <span class="comment">//服务端的fd对应着null值</span></div><div class="line">    fds.add(sServerSocket.getFileDescriptor());</div><div class="line">    peers.add(<span class="keyword">null</span>);</div><div class="line">    </div><div class="line">    <span class="comment">//进入无限循环， 采用 多路复用机制 + socket配合 进行阻塞等待client的请求</span></div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">        <span class="comment">//监听所有的fd的POLLIN请求，即监听socket可读事件</span></div><div class="line">        StructPollfd[] pollFds = <span class="keyword">new</span> StructPollfd[fds.size()];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pollFds.length; ++i) &#123;</div><div class="line">            pollFds[i] = <span class="keyword">new</span> StructPollfd();</div><div class="line">            <span class="comment">////pollFds[0]即为fds[0]，也就是sServerSocket.fd</span></div><div class="line">            <span class="comment">//1. 一开始，zygote刚启动的时候，这个fds只有sServerSocket.fd一个元素</span></div><div class="line">            <span class="comment">//2. 当有新的client连接sServerSocket时候，就会触发sServerSocket.fd的POLLIN事件</span></div><div class="line">            <span class="comment">//3. 从而导致后面for循环中，i==0成立，然后往peers中新加一个peers，以及往fds列表中添加客户端的fd</span></div><div class="line">            pollFds[i].fd = fds.get(i);</div><div class="line">            pollFds[i].events = (<span class="keyword">short</span>) POLLIN;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//开始poll系统调用，监听多个文件的POLLIN事件，阻塞。 当有事件来临时，继续往下执行</span></div><div class="line">            Os.poll(pollFds, -<span class="number">1</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"poll failed"</span>, ex);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//遍历所有监控的fd，如果不存在POLLIN事件，则continue跳过该fd，否则执行后面的操作</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = pollFds.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</div><div class="line">            <span class="keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">//i=0，说明是zygote进程的server端的socket，因此调用socket.accept，获取与客户端的链接，从而拿到fd</span></div><div class="line">                ZygoteConnection newPeer = acceptCommandPeer(abiList);</div><div class="line">                peers.add(newPeer);</div><div class="line">                <span class="comment">//添加到fds列表</span></div><div class="line">                fds.add(newPeer.getFileDesciptor());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">//处理客户端链接</span></div><div class="line">                <span class="keyword">boolean</span> done = peers.get(i).runOnce();</div><div class="line">                <span class="comment">//处理完毕，将fd和peers删除</span></div><div class="line">                <span class="keyword">if</span> (done) &#123;</div><div class="line">                    peers.remove(i);</div><div class="line">                    fds.remove(i);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>开启sServerSocket，等待客户端请求</li>
<li>客户端请求来临，调用ZygoteConnection.runOnce()处理请求</li>
</ol>
<h3 id="调用ZygoteConnection-runOnce-处理请求"><a href="#调用ZygoteConnection-runOnce-处理请求" class="headerlink" title="调用ZygoteConnection.runOnce()处理请求"></a>调用ZygoteConnection.runOnce()处理请求</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">runOnce</span><span class="params">()</span> <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</div><div class="line">    </div><div class="line">    ...</div><div class="line">    </div><div class="line">    <span class="comment">//读取client端入参列表</span></div><div class="line">    args = readArgumentList();</div><div class="line">    </div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keyword">int</span> pid = -<span class="number">1</span>;</div><div class="line">    </div><div class="line">    ...</div><div class="line">    <span class="comment">//fork进程</span></div><div class="line">    pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,</div><div class="line">            parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,</div><div class="line">            parsedArgs.niceName, fdsToClose, parsedArgs.instructionSet,</div><div class="line">            parsedArgs.appDataDir);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// in child</span></div><div class="line">            IoUtils.closeQuietly(serverPipeFd);</div><div class="line">            serverPipeFd = <span class="keyword">null</span>;</div><div class="line">            handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);</div><div class="line"></div><div class="line">            <span class="comment">// should never get here, the child is expected to either</span></div><div class="line">            <span class="comment">// throw ZygoteInit.MethodAndArgsCaller or exec().</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// in parent...pid of &lt; 0 means failure</span></div><div class="line">            IoUtils.closeQuietly(childPipeFd);</div><div class="line">            childPipeFd = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">return</span> handleParentProc(pid, descriptors, serverPipeFd, parsedArgs);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        IoUtils.closeQuietly(childPipeFd);</div><div class="line">        IoUtils.closeQuietly(serverPipeFd);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="handleChildProc-与-handleParentProc"><a href="#handleChildProc-与-handleParentProc" class="headerlink" title="handleChildProc 与 handleParentProc"></a>handleChildProc 与 handleParentProc</h3><p>首先来看 handleChildProc，即zygote进程fork出来的子进程执行的方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleChildProc</span><span class="params">(Arguments parsedArgs,</span></span></div><div class="line"><span class="function"><span class="params">        FileDescriptor[] descriptors, FileDescriptor pipeFd, PrintStream newStderr)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * By the time we get here, the native code has closed the two actual Zygote</span></div><div class="line"><span class="comment">     * socket connections, and substituted /dev/null in their place.  The LocalSocket</span></div><div class="line"><span class="comment">     * objects still need to be closed properly.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    </div><div class="line">    <span class="comment">//子进程不再需要处理socket请求，因此关掉两端</span></div><div class="line">    closeSocket();</div><div class="line">    ZygoteInit.closeServerSocket();</div><div class="line">      </div><div class="line">    ...</div><div class="line">    </div><div class="line">    <span class="comment">//子进程名字的设置</span></div><div class="line">    <span class="keyword">if</span> (parsedArgs.niceName != <span class="keyword">null</span>) &#123;</div><div class="line">        Process.setArgV0(parsedArgs.niceName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// End of the postFork event.</span></div><div class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">    <span class="comment">//如果定义了invokeWith参数，则采用 /system/bin/sh这种execShell的方式执行command</span></div><div class="line">    <span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</div><div class="line">        WrapperInit.execApplication(parsedArgs.invokeWith,</div><div class="line">                parsedArgs.niceName, parsedArgs.targetSdkVersion,</div><div class="line">                VMRuntime.getCurrentInstructionSet(),</div><div class="line">                pipeFd, parsedArgs.remainingArgs);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">//否则调用zygoteInit，执行初始化</span></div><div class="line">        RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion,</div><div class="line">                parsedArgs.remainingArgs, <span class="keyword">null</span> <span class="comment">/* classLoader */</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="RuntimeInit-zygoteInit"><a href="#RuntimeInit-zygoteInit" class="headerlink" title="RuntimeInit.zygoteInit"></a>RuntimeInit.zygoteInit</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">zygoteInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</div><div class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"RuntimeInit: Starting application from zygote"</span>);</div><div class="line"></div><div class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"RuntimeInit"</span>);</div><div class="line">    <span class="comment">//log重定向</span></div><div class="line">    redirectLogStreams();</div><div class="line">    </div><div class="line">    <span class="comment">//通用初始化：default UncaughtExceptionHandler、TimeZone、userAgent、NetworkManagementSocketTagger、trace等等</span></div><div class="line">    commonInit();</div><div class="line">    </div><div class="line">    <span class="comment">//调用frameworks/base/core/jni/AndroidRuntime.cpp</span></div><div class="line">    <span class="comment">//最终调用gCurRuntime-&gt;onZygoteInit，其中gCurRuntime是在zygote进程执行app_main.cpp-&gt;main()时创建的，</span></div><div class="line">    <span class="comment">//而新fork出来的子进程都是基于zygote进程的，因此也会存在该实例</span></div><div class="line">    <span class="comment">//调用AndroidRuntime.onZygoteInit()方法，与binder交互</span></div><div class="line">    nativeZygoteInit();</div><div class="line">    <span class="comment">//应用初始化</span></div><div class="line">    applicationInit(targetSdkVersion, argv, classLoader);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>startThreadPool方法的调用， 参考链接：<a href="http://blog.csdn.net/ganyue803/article/details/41484849" target="_blank" rel="external">http://blog.csdn.net/ganyue803/article/details/41484849</a><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onZygoteInit</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="comment">//binder交互</span></div><div class="line">    sp&lt;ProcessState&gt; proc = ProcessState::self();</div><div class="line">    ALOGV(<span class="string">"App process: starting thread pool.\n"</span>);</div><div class="line">    <span class="comment">//开启主线程，并与binder 最终talkWithDriver()</span></div><div class="line">    proc-&gt;startThreadPool();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="RuntimeInit-applicationInit"><a href="#RuntimeInit-applicationInit" class="headerlink" title="RuntimeInit.applicationInit"></a>RuntimeInit.applicationInit</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">applicationInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</div><div class="line">    <span class="comment">// If the application calls System.exit(), terminate the process</span></div><div class="line">    <span class="comment">// immediately without running any shutdown hooks.  It is not possible to</span></div><div class="line">    <span class="comment">// shutdown an Android application gracefully.  Among other things, the</span></div><div class="line">    <span class="comment">// Android runtime shutdown hooks close the Binder driver, which can cause</span></div><div class="line">    <span class="comment">// leftover running threads to crash before the process actually exits.</span></div><div class="line">    nativeSetExitWithoutCleanup(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="comment">// We want to be fairly aggressive about heap utilization, to avoid</span></div><div class="line">    <span class="comment">// holding on to a lot of memory that isn't needed.</span></div><div class="line">    VMRuntime.getRuntime().setTargetHeapUtilization(<span class="number">0.75f</span>);</div><div class="line">    VMRuntime.getRuntime().setTargetSdkVersion(targetSdkVersion);</div><div class="line"></div><div class="line">    <span class="keyword">final</span> Arguments args;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        args = <span class="keyword">new</span> Arguments(argv);</div><div class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">        Slog.e(TAG, ex.getMessage());</div><div class="line">        <span class="comment">// let the process exit</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// The end of of the RuntimeInit event (see #zygoteInit).</span></div><div class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line"></div><div class="line">    <span class="comment">// Remaining arguments are passed to the start class's static main</span></div><div class="line">    invokeStaticMain(args.startClass, args.startArgs, classLoader);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="RuntimeInit-invokeStaticMain"><a href="#RuntimeInit-invokeStaticMain" class="headerlink" title="RuntimeInit.invokeStaticMain"></a>RuntimeInit.invokeStaticMain</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeStaticMain</span><span class="params">(String className, String[] argv, ClassLoader classLoader)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</div><div class="line">    Class&lt;?&gt; cl;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        cl = Class.forName(className, <span class="keyword">true</span>, classLoader);</div><div class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                <span class="string">"Missing class when invoking static main "</span> + className,</div><div class="line">                ex);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Method m;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        m = cl.getMethod(<span class="string">"main"</span>, <span class="keyword">new</span> Class[] &#123; String[].class &#125;);</div><div class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                <span class="string">"Missing static main on "</span> + className, ex);</div><div class="line">    &#125; <span class="keyword">catch</span> (SecurityException ex) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                <span class="string">"Problem getting static main on "</span> + className, ex);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> modifiers = m.getModifiers();</div><div class="line">    <span class="keyword">if</span> (! (Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                <span class="string">"Main method is not public and static on "</span> + className);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * This throw gets caught in ZygoteInit.main(), which responds</span></div><div class="line"><span class="comment">     * by invoking the exception's run() method. This arrangement</span></div><div class="line"><span class="comment">     * clears up all the stack frames that were required in setting</span></div><div class="line"><span class="comment">     * up the process.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteInit.MethodAndArgsCaller(m, argv);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终，子进程中，调用invokeStaticMain，抛出ZygoteInit.MethodAndArgsCaller异常，从而跳转到ZygoteInit.main()方法的exception处理中，调用caller.run();</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        mMethod.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> Object[] &#123; mArgs &#125;);</div><div class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</div><div class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</div><div class="line">        Throwable cause = ex.getCause();</div><div class="line">        <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> RuntimeException) &#123;</div><div class="line">            <span class="keyword">throw</span> (RuntimeException) cause;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> Error) &#123;</div><div class="line">            <span class="keyword">throw</span> (Error) cause;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>即，调用ZygoteInit.MethodAndArgsCaller(m, argv)这个main方法，并传参argv</p>
<p>而对于父进程，也就是我们的zygote进程， 来看看handleParentProc<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">handleParentProc</span><span class="params">(<span class="keyword">int</span> pid,</span></span></div><div class="line"><span class="function"><span class="params">        FileDescriptor[] descriptors, FileDescriptor pipeFd, Arguments parsedArgs)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</div><div class="line">        setChildPgid(pid);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (descriptors != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (FileDescriptor fd: descriptors) &#123;</div><div class="line">            IoUtils.closeQuietly(fd);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> usingWrapper = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (pipeFd != <span class="keyword">null</span> &amp;&amp; pid &gt; <span class="number">0</span>) &#123;</div><div class="line">        DataInputStream is = <span class="keyword">new</span> DataInputStream(<span class="keyword">new</span> FileInputStream(pipeFd));</div><div class="line">        <span class="keyword">int</span> innerPid = -<span class="number">1</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            innerPid = is.readInt();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">            Log.w(TAG, <span class="string">"Error reading pid from wrapped process, child may have died"</span>, ex);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                is.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Ensure that the pid reported by the wrapped process is either the</span></div><div class="line">        <span class="comment">// child process that we forked, or a descendant of it.</span></div><div class="line">        <span class="keyword">if</span> (innerPid &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">int</span> parentPid = innerPid;</div><div class="line">            <span class="keyword">while</span> (parentPid &gt; <span class="number">0</span> &amp;&amp; parentPid != pid) &#123;</div><div class="line">                parentPid = Process.getParentPid(parentPid);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (parentPid &gt; <span class="number">0</span>) &#123;</div><div class="line">                Log.i(TAG, <span class="string">"Wrapped process has pid "</span> + innerPid);</div><div class="line">                pid = innerPid;</div><div class="line">                usingWrapper = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                Log.w(TAG, <span class="string">"Wrapped process reported a pid that is not a child of "</span></div><div class="line">                        + <span class="string">"the process that we forked: childPid="</span> + pid</div><div class="line">                        + <span class="string">" innerPid="</span> + innerPid);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        mSocketOutStream.writeInt(pid);</div><div class="line">        mSocketOutStream.writeBoolean(usingWrapper);</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">        Log.e(TAG, <span class="string">"Error writing to command socket"</span>, ex);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>主要做了一些fork清理工作，并没有抛出异常，因此还是在runSelectLoop这个循环中继续往下执行</p>
<h1 id="完结"><a href="#完结" class="headerlink" title="完结"></a>完结</h1><p>至此，整个zygote进程的启动流程执行完毕，主要做了以下事情：</p>
<ol>
<li>app_main.cpp -&gt; main()， AppRuntime的初始化：创建虚拟机、注册jni函数</li>
<li>执行com.android.internal.os.ZygoteInit -&gt; main()函数</li>
<li>registerZygoteSocket注册服务端sServerSocket</li>
<li>preload: 基本资源、库的加载</li>
<li>如果需要启动systemserver，则启动systemserver进程</li>
<li>runSelectLoop： 进入无限循环，采用poll + socket的机制，等待client端的请求<br>6.1 请求过来，fork进程，并在新的进程中运行class的main方法<br>6.2 父进程做完清理工作，继续在无限循环中执行</li>
</ol>
<p>参考链接：<br><a href="http://blog.csdn.net/yaowei514473839/article/details/53022493" target="_blank" rel="external">http://blog.csdn.net/yaowei514473839/article/details/53022493</a><br><a href="http://blog.csdn.net/yaowei514473839/article/details/53045285" target="_blank" rel="external">http://blog.csdn.net/yaowei514473839/article/details/53045285</a></p>
</div><div class="tags"><a href="/tags/Android/">Android</a><a href="/tags/源码阅读/">源码阅读</a></div><div class="post-nav"><a href="/2017/09/27/Android启动源码阅读(三)systemserver的启动过程/" class="next">Android启动源码阅读(三)systemserver进程的启动</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.molingyu.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/学习笔记/">学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/源码阅读/" style="font-size: 15px;">源码阅读</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/C-C/" style="font-size: 15px;">C/C++</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/27/Android启动源码阅读(二)zygote进程的启动/">Android启动源码阅读(二)zygote进程的启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/27/Android启动源码阅读(三)systemserver的启动过程/">Android启动源码阅读(三)systemserver进程的启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/26/Android启动源码阅读(一)init进程的启动/">Android启动源码阅读(一)init进程的启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/25/Android源码阅读技巧/">Android源码阅读准备</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/18/一个epoll实例/">一个epoll实例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/17/本博客的建立/">本博客的建立</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/17/ReentrantLock/">ReentrantLock</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/JakeWharton" title="JakeWharton" target="_blank">JakeWharton</a><ul></ul><a href="https://github.com/Trinea" title="Trinea" target="_blank">Trinea</a><ul></ul><a href="http://blog.csdn.net/luoshengyang" title="罗升阳" target="_blank">罗升阳</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">子墨.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Maupassant</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>