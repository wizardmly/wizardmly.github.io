<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Android启动源码阅读(一)init进程的启动 | 子墨不语</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android启动源码阅读(一)init进程的启动</h1><a id="logo" href="/.">子墨不语</a><p class="description">路漫漫其修远兮，吾将上下而求索</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Android启动源码阅读(一)init进程的启动</h1><div class="post-meta">Sep 26, 2017<span> | </span><span class="category"><a href="/categories/学习笔记/">学习笔记</a></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#init启动解析-main函数"><span class="toc-number">1.</span> <span class="toc-text">init启动解析: main函数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#init-rc文件的解析过程"><span class="toc-number">1.1.</span> <span class="toc-text">init.rc文件的解析过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rc文件的变化"><span class="toc-number">1.1.1.</span> <span class="toc-text">rc文件的变化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解析源码段分析"><span class="toc-number">1.1.2.</span> <span class="toc-text">解析源码段分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ParseData-解析说明"><span class="toc-number">1.1.3.</span> <span class="toc-text">ParseData()解析说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#举例说明解析过程"><span class="toc-number">1.1.4.</span> <span class="toc-text">举例说明解析过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#restart-processes"><span class="toc-number">1.1.5.</span> <span class="toc-text">restart_processes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调用到了Service-Start-方法-system-core-init-service-cpp"><span class="toc-number">1.1.6.</span> <span class="toc-text">调用到了Service:Start()方法: system/core/init/service.cpp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#完结"><span class="toc-number">1.2.</span> <span class="toc-text">完结</span></a></li></ol></li></ol></div></div><div class="post-content"><p>在Linux系统中，Kernel启动完毕之后，启动的第一个用户空间的进程，就是名为<strong>init</strong>的进程：</p>
<p>以下是查找init进程源码的过程：</p>
<ol>
<li><p>查找init进程mk文件位置：</p>
<p>查找可执行程序：init的编译MODULE定义，即全局查找字符串: LOCAL_MODULE:= init，从而找到mk文件位置system/core/init/Android.mk</p>
</li>
<li><p>从MODULE的LOCAL_SRC_FILES找到init.cpp文件</p>
</li>
<li><p>全局查找文件(按两次)init.cpp，从而最终找到init.cpp的源码system/core/init/init.cpp</p>
</li>
</ol>
<h1 id="init启动解析-main函数"><a href="#init启动解析-main函数" class="headerlink" title="init启动解析: main函数"></a>init启动解析: main函数</h1><p>作为init可执行文件的入口init.cpp-&gt;main()，我们来看下它是怎么执行的<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 将/usr/bin:/bin加入到环境变量中去</span></div><div class="line">    add_environment(<span class="string">"PATH"</span>, _PATH_DEFPATH);</div><div class="line"></div><div class="line">    <span class="keyword">bool</span> is_first_stage = (argc == <span class="number">1</span>) || (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--second-stage"</span>) != <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Get the basic filesystem setup we need put together in the initramdisk</span></div><div class="line">    <span class="comment">// on / and then we'll let the rc file figure out the rest.</span></div><div class="line">    <span class="keyword">if</span> (is_first_stage) &#123;</div><div class="line">        mount(<span class="string">"tmpfs"</span>, <span class="string">"/dev"</span>, <span class="string">"tmpfs"</span>, MS_NOSUID, <span class="string">"mode=0755"</span>);</div><div class="line">        mkdir(<span class="string">"/dev/pts"</span>, <span class="number">0755</span>);</div><div class="line">        mkdir(<span class="string">"/dev/socket"</span>, <span class="number">0755</span>);</div><div class="line">        mount(<span class="string">"devpts"</span>, <span class="string">"/dev/pts"</span>, <span class="string">"devpts"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">        <span class="meta">#<span class="meta-keyword">define</span> MAKE_STR(x) __STRING(x)</span></div><div class="line">        mount(<span class="string">"proc"</span>, <span class="string">"/proc"</span>, <span class="string">"proc"</span>, <span class="number">0</span>, <span class="string">"hidepid=2,gid="</span> MAKE_STR(AID_READPROC));</div><div class="line">        mount(<span class="string">"sysfs"</span>, <span class="string">"/sys"</span>, <span class="string">"sysfs"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="comment">// Set up SELinux, including loading the SELinux policy if we're in the kernel domain.</span></div><div class="line">    selinux_initialize(is_first_stage);</div><div class="line">    </div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="comment">// These directories were necessarily created before initial policy load</span></div><div class="line">    <span class="comment">// and therefore need their security context restored to the proper value.</span></div><div class="line">    <span class="comment">// This must happen before /dev is populated by ueventd.</span></div><div class="line">    NOTICE(<span class="string">"Running restorecon...\n"</span>);</div><div class="line">    restorecon(<span class="string">"/dev"</span>);</div><div class="line">    restorecon(<span class="string">"/dev/socket"</span>);</div><div class="line">    restorecon(<span class="string">"/dev/__properties__"</span>);</div><div class="line">    restorecon(<span class="string">"/property_contexts"</span>);</div><div class="line">    restorecon_recursive(<span class="string">"/sys"</span>);</div><div class="line"></div><div class="line">    epoll_fd = epoll_create1(EPOLL_CLOEXEC);</div><div class="line">    </div><div class="line">    ...</div><div class="line">    </div><div class="line">    <span class="comment">//信号处理handler初始化：通过信号量，管理init fork出来的子进程</span></div><div class="line">    signal_handler_init();</div><div class="line">    <span class="comment">//导入默认boot_property</span></div><div class="line">    property_load_boot_defaults();</div><div class="line">    <span class="comment">//导入oem锁状态</span></div><div class="line">    export_oem_lock_status();</div><div class="line">    <span class="comment">//属性服务初始化</span></div><div class="line">    start_property_service();</div><div class="line">    </div><div class="line">    <span class="comment">//创建内建的函数映射key-func的map集合，Action解析触发都依赖与该map查找对应的函数</span></div><div class="line">    <span class="keyword">const</span> BuiltinFunctionMap function_map;</div><div class="line">    Action::set_function_map(&amp;function_map);</div><div class="line"></div><div class="line">    <span class="comment">//init.rc文件的解析</span></div><div class="line">    Parser&amp; parser = Parser::GetInstance();</div><div class="line">    parser.AddSectionParser(<span class="string">"service"</span>,<span class="built_in">std</span>::make_unique&lt;ServiceParser&gt;());</div><div class="line">    parser.AddSectionParser(<span class="string">"on"</span>, <span class="built_in">std</span>::make_unique&lt;ActionParser&gt;());</div><div class="line">    parser.AddSectionParser(<span class="string">"import"</span>, <span class="built_in">std</span>::make_unique&lt;ImportParser&gt;());</div><div class="line">    <span class="comment">//开始解析</span></div><div class="line">    parser.ParseConfig(<span class="string">"/init.rc"</span>);</div><div class="line"></div><div class="line">    ActionManager&amp; am = ActionManager::GetInstance();</div><div class="line">    </div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="comment">// init进程进入该循环</span></div><div class="line">    <span class="comment">// 1. 执行am的命令</span></div><div class="line">    <span class="comment">// 2. 重启相关的process，这里其实是我们通过service启动的子进程</span></div><div class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (!waiting_for_exec) &#123;</div><div class="line">            am.ExecuteOneCommand();</div><div class="line">            restart_processes();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> timeout = <span class="number">-1</span>;</div><div class="line">        <span class="keyword">if</span> (process_needs_restart) &#123;</div><div class="line">            timeout = (process_needs_restart - gettime()) * <span class="number">1000</span>;</div><div class="line">            <span class="keyword">if</span> (timeout &lt; <span class="number">0</span>)</div><div class="line">                timeout = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (am.HasMoreCommands()) &#123;</div><div class="line">            timeout = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        bootchart_sample(&amp;timeout);</div><div class="line">        <span class="comment">//阻塞，等待新的command的到来</span></div><div class="line">        epoll_event ev;</div><div class="line">        <span class="keyword">int</span> nr = TEMP_FAILURE_RETRY(epoll_wait(epoll_fd, &amp;ev, <span class="number">1</span>, timeout));</div><div class="line">        <span class="keyword">if</span> (nr == <span class="number">-1</span>) &#123;</div><div class="line">            ERROR(<span class="string">"epoll_wait failed: %s\n"</span>, strerror(errno));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nr == <span class="number">1</span>) &#123;</div><div class="line">            ((<span class="keyword">void</span> (*)()) ev.data.ptr)();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>总结下来，init进程做了几件事情：</p>
<ol>
<li>bin环境变量的添加</li>
<li>所需的文件系统的挂载</li>
<li>信号处理、oem锁、属性服务启动</li>
<li>init.rc文件的解析</li>
<li>进入循环，通过ActionManager开始执行Command</li>
<li>restart_processes，重新启动process，如果有必要的话</li>
</ol>
<p>本文，我们只关注两点：</p>
<ol>
<li>rc文件的解析</li>
<li>restart_processes 启动新的process</li>
</ol>
<h2 id="init-rc文件的解析过程"><a href="#init-rc文件的解析过程" class="headerlink" title="init.rc文件的解析过程"></a>init.rc文件的解析过程</h2><p>init.rc文件位于system/core/rootdir/init.rc</p>
<h3 id="rc文件的变化"><a href="#rc文件的变化" class="headerlink" title="rc文件的变化"></a>rc文件的变化</h3><p>在 7.+ 版本的系统中，rc文件的内容根据具体的模块拆分成不同的rc文件，</p>
<p>比如init.rc文件的头部:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">import /init.environ.rc</div><div class="line">import /init.usb.rc</div><div class="line">import /init.$&#123;ro.hardware&#125;.rc</div><div class="line">import /init.usb.configfs.rc</div><div class="line">import /init.$&#123;ro.zygote&#125;.rc</div></pre></td></tr></table></figure></p>
<p>又比如servicemanager的初始化： frameworks/native/cmds/servicemanager/servicemanager.rc</p>
<p>参考链接：<a href="http://blog.csdn.net/sunao2002002/article/details/52454878" target="_blank" rel="external">http://blog.csdn.net/sunao2002002/article/details/52454878</a></p>
<h3 id="解析源码段分析"><a href="#解析源码段分析" class="headerlink" title="解析源码段分析"></a>解析源码段分析</h3><p>先来看看代码段<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Parser&amp; parser = Parser::GetInstance();</div><div class="line">parser.AddSectionParser(<span class="string">"service"</span>,<span class="built_in">std</span>::make_unique&lt;ServiceParser&gt;());</div><div class="line">parser.AddSectionParser(<span class="string">"on"</span>, <span class="built_in">std</span>::make_unique&lt;ActionParser&gt;());</div><div class="line">parser.AddSectionParser(<span class="string">"import"</span>, <span class="built_in">std</span>::make_unique&lt;ImportParser&gt;());</div><div class="line">parser.ParseConfig(<span class="string">"/init.rc"</span>);</div></pre></td></tr></table></figure></p>
<ol>
<li><p>Parser是一个单例，全局字符串查找 Parser::GetInstance，即可找到定义位置system/core/init/init_parser.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Parser&amp; Parser::GetInstance() &#123;</div><div class="line">    <span class="keyword">static</span> Parser instance;</div><div class="line">    <span class="keyword">return</span> instance;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>调用AddSectionParser将几个解析器放置到map中：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> Parser::AddSectionParser(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name,</div><div class="line">                              <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;SectionParser&gt; parser) &#123;</div><div class="line">    section_parsers_[name] = <span class="built_in">std</span>::move(parser);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>开始解析:<code>parser.ParseConfig(&quot;/init.rc&quot;);</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> Parser::ParseConfig(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; path) &#123;</div><div class="line">    <span class="keyword">if</span> (is_dir(path.c_str())) &#123;</div><div class="line">        <span class="keyword">return</span> ParseConfigDir(path);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ParseConfigFile(path);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>由于传入的”/init.rc”是一个文件，因此开始<code>ParseConfigFile(path)</code>解析</p>
<ol>
<li>file解析<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> Parser::ParseConfigFile(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; path) &#123;</div><div class="line">    INFO(<span class="string">"Parsing file %s...\n"</span>, path.c_str());</div><div class="line">    Timer t;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> data;</div><div class="line">    <span class="comment">//将file内容读入data字符串中</span></div><div class="line">    <span class="keyword">if</span> (!read_file(path.c_str(), &amp;data)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//内容字符串修正</span></div><div class="line">    data.push_back(<span class="string">'\n'</span>); <span class="comment">// <span class="doctag">TODO:</span> fix parse_config.</span></div><div class="line">    <span class="comment">//4.1 解析文件内容</span></div><div class="line">    ParseData(path, data);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; sp : section_parsers_) &#123;</div><div class="line">        <span class="comment">//4.2 解析文件完毕</span></div><div class="line">        sp.second-&gt;EndFile(path);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Turning this on and letting the INFO logging be discarded adds 0.2s to</span></div><div class="line">    <span class="comment">// Nexus 9 boot time, so it's disabled by default.</span></div><div class="line">    <span class="keyword">if</span> (<span class="literal">false</span>) DumpState();</div><div class="line"></div><div class="line">    NOTICE(<span class="string">"(Parsing %s took %.2fs.)\n"</span>, path.c_str(), t.duration());</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="ParseData-解析说明"><a href="#ParseData-解析说明" class="headerlink" title="ParseData()解析说明"></a>ParseData()解析说明</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> Parser::ParseData(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; filename, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; data) &#123;</div><div class="line">    <span class="comment">//<span class="doctag">TODO:</span> Use a parser with const input and remove this copy</span></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">char</span>&gt; data_copy(data.begin(), data.end());</div><div class="line">    data_copy.push_back(<span class="string">'\0'</span>);</div><div class="line">    <span class="comment">//初始化解析参数</span></div><div class="line">    parse_state state;</div><div class="line">    state.filename = filename.c_str();</div><div class="line">    state.line = <span class="number">0</span>;</div><div class="line">    state.ptr = &amp;data_copy[<span class="number">0</span>];</div><div class="line">    state.nexttoken = <span class="number">0</span>;</div><div class="line">    <span class="comment">//解析器</span></div><div class="line">    SectionParser* section_parser = <span class="literal">nullptr</span>;</div><div class="line">    <span class="comment">//解析出来的参数存放位置</span></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; args;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (;;) &#123;</div><div class="line">        <span class="comment">//next_token()：真正解析文件的地方</span></div><div class="line">        <span class="keyword">switch</span> (next_token(&amp;state)) &#123;</div><div class="line">        <span class="keyword">case</span> T_EOF:</div><div class="line">            <span class="comment">//解析到文件末尾</span></div><div class="line">            <span class="keyword">if</span> (section_parser) &#123;</div><div class="line">                section_parser-&gt;EndSection();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">case</span> T_NEWLINE:</div><div class="line">            <span class="comment">//新行</span></div><div class="line">            state.line++;</div><div class="line">            <span class="keyword">if</span> (args.empty()) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (section_parsers_.count(args[<span class="number">0</span>])) &#123;</div><div class="line">                <span class="comment">//新的一行开始，如果此前的section_parser不为空，则结束那一行的解析：EndSection</span></div><div class="line">                <span class="keyword">if</span> (section_parser) &#123;</div><div class="line">                    section_parser-&gt;EndSection();</div><div class="line">                &#125;</div><div class="line">                section_parser = section_parsers_[args[<span class="number">0</span>]].get();</div><div class="line">                <span class="built_in">std</span>::<span class="built_in">string</span> ret_err;</div><div class="line">                <span class="keyword">if</span> (!section_parser-&gt;ParseSection(args, &amp;ret_err)) &#123;</div><div class="line">                    parse_error(&amp;state, <span class="string">"%s\n"</span>, ret_err.c_str());</div><div class="line">                    section_parser = <span class="literal">nullptr</span>;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (section_parser) &#123;</div><div class="line">                <span class="built_in">std</span>::<span class="built_in">string</span> ret_err;</div><div class="line">                <span class="keyword">if</span> (!section_parser-&gt;ParseLineSection(args, state.filename,</div><div class="line">                                                      state.line, &amp;ret_err)) &#123;</div><div class="line">                    parse_error(&amp;state, <span class="string">"%s\n"</span>, ret_err.c_str());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            args.clear();</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> T_TEXT:</div><div class="line">            <span class="comment">//解析到字符串内容：例如 service zygote /system/bin/app_process</span></div><div class="line">            <span class="comment">//则解析到的结果是args=&#123;"service", "zygote", "/system/bin/app_process"&#125;</span></div><div class="line">            args.emplace_back(state.text);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>GetInstance</p>
<h3 id="举例说明解析过程"><a href="#举例说明解析过程" class="headerlink" title="举例说明解析过程"></a>举例说明解析过程</h3><ol>
<li>读取init.rc文件时，遇到import语句，因此args[0] = “import”，采用ImportParser进行解析</li>
<li><p>调用ImportParser-&gt;ParseSection进行解析：args={“import”, “/init.${ro.zygote}.rc”}</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> ImportParser::ParseSection(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args,</div><div class="line">                                <span class="built_in">std</span>::<span class="built_in">string</span>* err) &#123;</div><div class="line">    <span class="keyword">if</span> (args.size() != <span class="number">2</span>) &#123;</div><div class="line">        *err = <span class="string">"single argument needed for import\n"</span>;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> conf_file;</div><div class="line">    <span class="comment">//通过expand_props将$&#123;ro.zygote&#125;替换成对应平台的实现，例如zygote32，因此文件名为：init.zygote32.rc</span></div><div class="line">    <span class="keyword">bool</span> ret = expand_props(args[<span class="number">1</span>], &amp;conf_file);</div><div class="line">    <span class="keyword">if</span> (!ret) &#123;</div><div class="line">        *err = <span class="string">"error while expanding import"</span>;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    INFO(<span class="string">"Added '%s' to import list\n"</span>, conf_file.c_str());</div><div class="line">    <span class="comment">//将解析出来，import的真正文件名放到imports_列表中</span></div><div class="line">    imports_.emplace_back(<span class="built_in">std</span>::move(conf_file));</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>回到Parser::ParseConfigFile，当文件解析完毕之后，调用所有的Parser-&gt;EndFile</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; sp : section_parsers_) &#123;</div><div class="line">    <span class="comment">//4.2 解析文件完毕</span></div><div class="line">    sp.second-&gt;EndFile(path);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>因此，我们看下ImportParser-&gt;EndFile():<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> ImportParser::EndFile(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; filename) &#123;</div><div class="line">    <span class="keyword">auto</span> current_imports = <span class="built_in">std</span>::move(imports_);</div><div class="line">    imports_.clear();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; s : current_imports) &#123;</div><div class="line">        <span class="keyword">if</span> (!Parser::GetInstance().ParseConfig(s)) &#123;</div><div class="line">            ERROR(<span class="string">"could not import file '%s' from '%s': %s\n"</span>,</div><div class="line">                  s.c_str(), filename.c_str(), strerror(errno));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由此可见，又针对每个文件，进行了Parser::GetInstance().ParseConfig(s)解析</p>
<ol>
<li><p>imprt进来的file的解析步骤仍然走的：</p>
<ul>
<li>Parser::ParseConfig</li>
<li>Parser::ParseConfigFile</li>
<li>循环1. Parser::ParseData</li>
<li>循环2. system/core/init/parser.cpp-&gt;next_token()</li>
<li>循环3. Parser::ParseSection</li>
<li>循环4. Parser::EndSection</li>
</ul>
</li>
<li><p>我们来看service的解析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server</div><div class="line">    class main</div><div class="line">    socket zygote stream 660 root system</div><div class="line">    onrestart write /sys/android_power/request_state wake</div><div class="line">    onrestart write /sys/power/state on</div><div class="line">    onrestart restart audioserver</div><div class="line">    onrestart restart cameraserver</div><div class="line">    onrestart restart media</div><div class="line">    onrestart restart netd</div><div class="line">    writepid /dev/cpuset/foreground/tasks</div></pre></td></tr></table></figure>
<ol>
<li>在ParserData()的时候，args[0]=”service”，采用ServiceParser进行解析<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> ServiceParser::ParseSection(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args,</div><div class="line">                                 <span class="built_in">std</span>::<span class="built_in">string</span>* err) &#123;</div><div class="line">    <span class="keyword">if</span> (args.size() &lt; <span class="number">3</span>) &#123;</div><div class="line">        *err = <span class="string">"services must have a name and a program"</span>;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name = args[<span class="number">1</span>];</div><div class="line">    <span class="keyword">if</span> (!IsValidName(name)) &#123;</div><div class="line">        *err = StringPrintf(<span class="string">"invalid service name '%s'"</span>, name.c_str());</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; str_args(args.begin() + <span class="number">2</span>, args.end());</div><div class="line">    service_ = <span class="built_in">std</span>::make_unique&lt;Service&gt;(name, <span class="string">"default"</span>, str_args);</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>由此可见，service关键字的解析，将会创建Service对象，并赋值给ServiceParser的service_成员</p>
<ol>
<li>当这一行解析完毕之后，进入下一行，由于下一行的args[0]不为{“service”，”on”,”import”}中的任意一个，因此进入解析方法ParseLineSection <figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> ServiceParser::ParseLineSection(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; filename, <span class="keyword">int</span> line, <span class="built_in">std</span>::<span class="built_in">string</span>* err) <span class="keyword">const</span> &#123;</div><div class="line">    <span class="keyword">return</span> service_ ? service_-&gt;HandleLine(args, err) : <span class="literal">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>HandleLine方法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> Service::HandleLine(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args, <span class="built_in">std</span>::<span class="built_in">string</span>* err) &#123;</div><div class="line">    <span class="keyword">if</span> (args.empty()) &#123;</div><div class="line">        *err = <span class="string">"option needed, but not provided"</span>;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//根据OptionHandlerMap,找寻args[0]所对应的函数</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> OptionHandlerMap handler_map;</div><div class="line">    <span class="keyword">auto</span> handler = handler_map.FindFunction(args[<span class="number">0</span>], args.size() - <span class="number">1</span>, err);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!handler) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//找到args[0]对应的方法，调用该方法，并将方法的返回值true/false，</span></div><div class="line">    <span class="comment">//返回: 这些方法基本上都是service_的属性设置，返回的都是boolean值</span></div><div class="line">    <span class="keyword">return</span> (<span class="keyword">this</span>-&gt;*handler)(args, err);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>//OptionHandlerMap定义如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Service::OptionHandlerMap::Map&amp; Service::OptionHandlerMap::<span class="built_in">map</span>() <span class="keyword">const</span> &#123;</div><div class="line">    <span class="keyword">constexpr</span> <span class="built_in">std</span>::<span class="keyword">size_t</span> kMax = <span class="built_in">std</span>::numeric_limits&lt;<span class="built_in">std</span>::<span class="keyword">size_t</span>&gt;::max();</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> Map option_handlers = &#123;</div><div class="line">        &#123;<span class="string">"class"</span>,       &#123;<span class="number">1</span>,     <span class="number">1</span>,    &amp;Service::HandleClass&#125;&#125;,</div><div class="line">        &#123;<span class="string">"console"</span>,     &#123;<span class="number">0</span>,     <span class="number">0</span>,    &amp;Service::HandleConsole&#125;&#125;,</div><div class="line">        &#123;<span class="string">"critical"</span>,    &#123;<span class="number">0</span>,     <span class="number">0</span>,    &amp;Service::HandleCritical&#125;&#125;,</div><div class="line">        &#123;<span class="string">"disabled"</span>,    &#123;<span class="number">0</span>,     <span class="number">0</span>,    &amp;Service::HandleDisabled&#125;&#125;,</div><div class="line">        &#123;<span class="string">"group"</span>,       &#123;<span class="number">1</span>,     NR_SVC_SUPP_GIDS + <span class="number">1</span>, &amp;Service::HandleGroup&#125;&#125;,</div><div class="line">        &#123;<span class="string">"ioprio"</span>,      &#123;<span class="number">2</span>,     <span class="number">2</span>,    &amp;Service::HandleIoprio&#125;&#125;,</div><div class="line">        &#123;<span class="string">"keycodes"</span>,    &#123;<span class="number">1</span>,     kMax, &amp;Service::HandleKeycodes&#125;&#125;,</div><div class="line">        &#123;<span class="string">"oneshot"</span>,     &#123;<span class="number">0</span>,     <span class="number">0</span>,    &amp;Service::HandleOneshot&#125;&#125;,</div><div class="line">        &#123;<span class="string">"onrestart"</span>,   &#123;<span class="number">1</span>,     kMax, &amp;Service::HandleOnrestart&#125;&#125;,</div><div class="line">        &#123;<span class="string">"seclabel"</span>,    &#123;<span class="number">1</span>,     <span class="number">1</span>,    &amp;Service::HandleSeclabel&#125;&#125;,</div><div class="line">        &#123;<span class="string">"setenv"</span>,      &#123;<span class="number">2</span>,     <span class="number">2</span>,    &amp;Service::HandleSetenv&#125;&#125;,</div><div class="line">        &#123;<span class="string">"socket"</span>,      &#123;<span class="number">3</span>,     <span class="number">6</span>,    &amp;Service::HandleSocket&#125;&#125;,</div><div class="line">        &#123;<span class="string">"user"</span>,        &#123;<span class="number">1</span>,     <span class="number">1</span>,    &amp;Service::HandleUser&#125;&#125;,</div><div class="line">        &#123;<span class="string">"writepid"</span>,    &#123;<span class="number">1</span>,     kMax, &amp;Service::HandleWritepid&#125;&#125;,</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">return</span> option_handlers;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>当所有的Line解析完毕，到达文件末尾，则调用ServiceParser::EndSection方法:<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> ServiceParser::EndSection() &#123;</div><div class="line">    <span class="keyword">if</span> (service_) &#123;</div><div class="line">        ServiceManager::GetInstance().AddService(<span class="built_in">std</span>::move(service_));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>将刚才解析的service_成员,move到ServiceManager的列表中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> ServiceManager::AddService(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Service&gt; service) &#123;</div><div class="line">    Service* old_service = FindServiceByName(service-&gt;name());</div><div class="line">    <span class="keyword">if</span> (old_service) &#123;</div><div class="line">        ERROR(<span class="string">"ignored duplicate definition of service '%s'"</span>,</div><div class="line">              service-&gt;name().c_str());</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    services_.emplace_back(<span class="built_in">std</span>::move(service));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>至此，init.zygote32.rc文件解析完毕</li>
</ol>
</li>
</ol>
<h3 id="restart-processes"><a href="#restart-processes" class="headerlink" title="restart_processes"></a>restart_processes</h3><p>前面分析init.cpp-&gt;main()函数的时候，在while循环中，调用了restart_processes方法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">restart_processes</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    process_needs_restart = <span class="number">0</span>;</div><div class="line">    ServiceManager::GetInstance().</div><div class="line">        ForEachServiceWithFlags(SVC_RESTARTING, [] (Service* s) &#123;</div><div class="line">                s-&gt;RestartIfNeeded(process_needs_restart);</div><div class="line">            &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> ServiceManager::ForEachServiceWithFlags(<span class="keyword">unsigned</span> matchflags,</div><div class="line">                                             <span class="keyword">void</span> (*func)(Service* svc)) <span class="keyword">const</span> &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; s : services_) &#123;</div><div class="line">        <span class="keyword">if</span> (s-&gt;flags() &amp; matchflags) &#123;</div><div class="line">            func(s.get());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从代码看到，这段代码对每一个Service，都进行了调用函数调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">：s-&gt;RestartIfNeeded(process_needs_restart);</div></pre></td></tr></table></figure></p>
<p>因此，最终调用到了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> Service::RestartIfNeeded(<span class="keyword">time_t</span>&amp; process_needs_restart) &#123;</div><div class="line">    <span class="keyword">time_t</span> next_start_time = time_started_ + <span class="number">5</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (next_start_time &lt;= gettime()) &#123;</div><div class="line">        flags_ &amp;= (~SVC_RESTARTING);</div><div class="line">        Start();</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((next_start_time &lt; process_needs_restart) ||</div><div class="line">        (process_needs_restart == <span class="number">0</span>)) &#123;</div><div class="line">        process_needs_restart = next_start_time;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="调用到了Service-Start-方法-system-core-init-service-cpp"><a href="#调用到了Service-Start-方法-system-core-init-service-cpp" class="headerlink" title="调用到了Service:Start()方法: system/core/init/service.cpp"></a>调用到了Service:Start()方法: system/core/init/service.cpp</h3><p>这段代码比较长，就不贴了，列举几个重要的片段：</p>
<ul>
<li><p>fork一个新的进程</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">pid_t</span> pid = fork();</div></pre></td></tr></table></figure>
</li>
<li><p>在新的进程中，如果sockets_不为空，就创建socket:  此处init.zygote32.rc文件中，socket zygote stream 660 root system</p>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; si : sockets_) &#123;</div><div class="line">    <span class="keyword">int</span> socket_type = ((si.type == <span class="string">"stream"</span> ? SOCK_STREAM :</div><div class="line">                        (si.type == <span class="string">"dgram"</span> ? SOCK_DGRAM :</div><div class="line">                         SOCK_SEQPACKET)));</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* socketcon =</div><div class="line">        !si.socketcon.empty() ? si.socketcon.c_str() : scon.c_str();</div><div class="line"></div><div class="line">    <span class="keyword">int</span> s = create_socket(si.name.c_str(), socket_type, si.perm,</div><div class="line">                          si.uid, si.gid, socketcon);</div><div class="line">    <span class="keyword">if</span> (s &gt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//调用PublishSocket，将si.name=zygote，设置到环境变量"ANDROID_SOCKET_ENV_PREFIX si.name"中去</span></div><div class="line">        PublishSocket(si.name, s);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//最终通过execve来执行 /system/bin/app_process</span></div><div class="line"><span class="keyword">if</span> (execve(strs[<span class="number">0</span>], (<span class="keyword">char</span>**) &amp;strs[<span class="number">0</span>], (<span class="keyword">char</span>**) ENV) &lt; <span class="number">0</span>) &#123;</div><div class="line">    ERROR(<span class="string">"cannot execve('%s'): %s\n"</span>, strs[<span class="number">0</span>], strerror(errno));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> Service::PublishSocket(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name, <span class="keyword">int</span> fd) <span class="keyword">const</span> &#123;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> key = StringPrintf(ANDROID_SOCKET_ENV_PREFIX <span class="string">"%s"</span>, name.c_str());</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> val = StringPrintf(<span class="string">"%d"</span>, fd);</div><div class="line">    add_environment(key.c_str(), val.c_str());</div><div class="line"></div><div class="line">    <span class="comment">/* make sure we don't close-on-exec */</span></div><div class="line">    fcntl(fd, F_SETFD, <span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因此会创建一个名为zygote的socket，挂在在/dev/socket/zygote节点下，</p>
<p>最终通过execve来执行 /system/bin/app_process</p>
<p>至此，一个service进程就解析，并创建进程，在新进程中开始执行</p>
<h2 id="完结"><a href="#完结" class="headerlink" title="完结"></a>完结</h2><p>上述分析，仅仅针对service关键字做了分析，其他的关键字on、class等等，同理分析</p>
<p>参考资料:</p>
<ul>
<li><a href="http://gityuan.com/2016/02/05/android-init/" target="_blank" rel="external">http://gityuan.com/2016/02/05/android-init/</a></li>
<li><a href="http://blog.csdn.net/A8316124/article/details/62224237" target="_blank" rel="external">http://blog.csdn.net/A8316124/article/details/62224237</a></li>
<li><a href="http://blog.csdn.net/sunao2002002/article/details/52454878" target="_blank" rel="external">http://blog.csdn.net/sunao2002002/article/details/52454878</a></li>
<li>system/core/init/readme.txt</li>
</ul>
</div><div class="tags"><a href="/tags/Android/">Android</a><a href="/tags/源码阅读/">源码阅读</a></div><div class="post-nav"><a href="/2017/09/27/Android启动源码阅读(二)zygote进程的启动/" class="pre">Android启动源码阅读(二)zygote进程的启动</a><a href="/2017/09/25/Android源码阅读技巧/" class="next">Android源码阅读准备</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.molingyu.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/学习笔记/">学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/源码阅读/" style="font-size: 15px;">源码阅读</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/前端/" style="font-size: 15px;">前端</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/10/由DBUtils使用ResultHandler引出的一个关于JavaBean反射的问题/">由DBUtils使用ResultHandler引出的一个关于JavaBean反射的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/09/前端学习笔记_JavaScript学习(一)/">前端学习笔记_JavaScript学习（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/27/Android启动源码阅读(三)systemserver的启动过程/">Android启动源码阅读(三)systemserver进程的启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/27/Android启动源码阅读(二)zygote进程的启动/">Android启动源码阅读(二)zygote进程的启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/26/Android启动源码阅读(一)init进程的启动/">Android启动源码阅读(一)init进程的启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/25/Android源码阅读技巧/">Android源码阅读准备</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/18/一个epoll实例/">一个epoll实例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/17/本博客的建立/">本博客的建立</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/17/ReentrantLock/">ReentrantLock</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/JakeWharton" title="JakeWharton" target="_blank">JakeWharton</a><ul></ul><a href="https://github.com/Trinea" title="Trinea" target="_blank">Trinea</a><ul></ul><a href="http://blog.csdn.net/luoshengyang" title="罗升阳" target="_blank">罗升阳</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">子墨.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Maupassant</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>