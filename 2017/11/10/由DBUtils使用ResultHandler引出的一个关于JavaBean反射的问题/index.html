<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>由DBUtils使用ResultHandler引出的一个关于JavaBean反射的问题 | 子墨不语</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">由DBUtils使用ResultHandler引出的一个关于JavaBean反射的问题</h1><a id="logo" href="/.">子墨不语</a><p class="description">路漫漫其修远兮，吾将上下而求索</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">由DBUtils使用ResultHandler引出的一个关于JavaBean反射的问题</h1><div class="post-meta">Nov 10, 2017<span> | </span><span class="category"><a href="/categories/学习笔记/">学习笔记</a></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#查看DBUtils的源码"><span class="toc-number">1.</span> <span class="toc-text">查看DBUtils的源码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#参考链接"><span class="toc-number">1.0.1.</span> <span class="toc-text">参考链接</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><p>今天搭建服务器，使用DBUtils处理数据库的时候，出了个小问题：<br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Device <span class="title">findById</span><span class="params">(String sn)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    String sql = <span class="string">"SELECT * FROM device WHERE sn=?"</span>;</div><div class="line">    QueryRunner runner = DBUtils.getQuerryRunner();</div><div class="line">    <span class="keyword">return</span> runner.query(sql, <span class="keyword">new</span> BeanHandler&lt;&gt;(Device.class), sn);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//定义业务Model定义</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Device</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> String sn;</div><div class="line">    <span class="keyword">public</span> String uuid;</div><div class="line">    <span class="keyword">public</span> String name;</div><div class="line">    <span class="keyword">public</span> String chargeAddr;</div><div class="line">    <span class="keyword">public</span> String addr1;</div><div class="line">    <span class="keyword">public</span> String addr2;</div><div class="line">    <span class="keyword">public</span> String firmware;</div><div class="line">    <span class="keyword">public</span> Float compensation;</div><div class="line">    <span class="keyword">public</span> Long lastUpdateTime;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最终，<strong>runner.query(</strong>返回的结果，是一个空的Device对象，即其内部成员都是null值。  而当我把Device定义成标准的JavaBean对象的时候，才能够正常的返回结果。</p>
<p>那么，这是为什么呢？ 源码是最好的老师…</p>
<h2 id="查看DBUtils的源码"><a href="#查看DBUtils的源码" class="headerlink" title="查看DBUtils的源码"></a>查看DBUtils的源码</h2><p>QueryRunner的源码位于：/commons-dbutils-1.7-sources.jar!/org/apache/commons/dbutils/QueryRunner.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">query</span><span class="params">(String sql, ResultSetHandler&lt;T&gt; rsh, Object... params)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    Connection conn = <span class="keyword">this</span>.prepareConnection();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.&lt;T&gt;query(conn, <span class="keyword">true</span>, sql, rsh, params);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">query</span><span class="params">(Connection conn, <span class="keyword">boolean</span> closeConn, String sql, ResultSetHandler&lt;T&gt; rsh, Object... params)</span></span></div><div class="line"><span class="function">            <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        </div><div class="line">        ......</div><div class="line"></div><div class="line">        PreparedStatement stmt = <span class="keyword">null</span>;</div><div class="line">        ResultSet rs = <span class="keyword">null</span>;</div><div class="line">        T result = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            stmt = <span class="keyword">this</span>.prepareStatement(conn, sql);</div><div class="line">            <span class="keyword">this</span>.fillStatement(stmt, params);</div><div class="line">            <span class="comment">//执行SQL语句，得到ResultSet结果集</span></div><div class="line">            rs = <span class="keyword">this</span>.wrap(stmt.executeQuery());</div><div class="line">            <span class="comment">//使用传入的rsh来处理结果集</span></div><div class="line">            result = rsh.handle(rs);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</div><div class="line">            <span class="keyword">this</span>.rethrow(e, sql, params);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                close(rs);</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                close(stmt);</div><div class="line">                <span class="keyword">if</span> (closeConn) &#123;</div><div class="line">                    close(conn);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>我们在调用的时候，传入了BeanHandler，所以使用了BeanHandler来处理结果集，其源码位于：/commons-dbutils-1.7-sources.jar!/org/apache/commons/dbutils/handlers/BeanHandler.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> RowProcessor ROW_PROCESSOR = <span class="keyword">new</span> BasicRowProcessor();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">BeanHandler</span><span class="params">(Class&lt;? extends T&gt; type)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(type, ArrayHandler.ROW_PROCESSOR);</div><div class="line">&#125;</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">BeanHandler</span><span class="params">(Class&lt;? extends T&gt; type, RowProcessor convert)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.type = type;</div><div class="line">    <span class="keyword">this</span>.convert = convert;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">handle</span><span class="params">(ResultSet rs)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    <span class="keyword">return</span> rs.next() ? <span class="keyword">this</span>.convert.toBean(rs, <span class="keyword">this</span>.type) : <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可见，在得到结果集之后，使用<strong>ArrayHandler.ROW_PROCESSOR.toBean()</strong>的方法来处理结果集</p>
<p>BasicRowProcessor源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BeanProcessor defaultConvert = <span class="keyword">new</span> BeanProcessor();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">BasicRowProcessor</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(defaultConvert);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">BasicRowProcessor</span><span class="params">(BeanProcessor convert)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>();</div><div class="line">    <span class="keyword">this</span>.convert = convert;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">toBean</span><span class="params">(ResultSet rs, Class&lt;? extends T&gt; type)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.convert.toBean(rs, type);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最终，调用到 /commons-dbutils-1.7-sources.jar!/org/apache/commons/dbutils/BeanProcessor.java 来处理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">toBean</span><span class="params">(ResultSet rs, Class&lt;? extends T&gt; type)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">	<span class="comment">//首先初始化一个type实例，在本例中，为Device实例</span></div><div class="line">    T bean = <span class="keyword">this</span>.newInstance(type);</div><div class="line">    <span class="comment">//开始填实例内容</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.populateBean(rs, bean);</div><div class="line">&#125;</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">populateBean</span><span class="params">(ResultSet rs, T bean)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">	<span class="comment">//首先获得bean的成员属性列表</span></div><div class="line">    PropertyDescriptor[] props = <span class="keyword">this</span>.propertyDescriptors(bean.getClass());</div><div class="line">    /拿到结果集中包含的meta data数据，也就是我们的数据库列</div><div class="line">    ResultSetMetaData rsmd = rs.getMetaData();</div><div class="line">    <span class="keyword">int</span>[] columnToProperty = <span class="keyword">this</span>.mapColumnsToProperties(rsmd, props);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> populateBean(rs, bean, props, columnToProperty);</div><div class="line">&#125;</div><div class="line"></div><div class="line">......</div></pre></td></tr></table></figure></p>
<p>我们先来看bean属性成员列表的获取，入参为Class对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> PropertyDescriptor[] propertyDescriptors(Class&lt;?&gt; c)</div><div class="line">    <span class="keyword">throws</span> SQLException &#123;</div><div class="line">    <span class="comment">// Introspector caches BeanInfo classes for better performance</span></div><div class="line">    BeanInfo beanInfo = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">    	<span class="comment">//通过Introspector.sgetBeanInfo获得对应Class的BeanInfo</span></div><div class="line">        beanInfo = Introspector.getBeanInfo(c);</div><div class="line"></div><div class="line">    &#125; <span class="keyword">catch</span> (IntrospectionException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(</div><div class="line">            <span class="string">"Bean introspection failed: "</span> + e.getMessage());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> beanInfo.getPropertyDescriptors();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们来看下src.zip!/java/beans/Introspector.java的getBeanInfo()方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BeanInfo <span class="title">getBeanInfo</span><span class="params">(Class&lt;?&gt; beanClass)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> IntrospectionException</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">	<span class="comment">//显然isPackageAccessible()返回true，因此不走这里</span></div><div class="line">    <span class="keyword">if</span> (!ReflectUtil.isPackageAccessible(beanClass)) &#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> Introspector(beanClass, <span class="keyword">null</span>, USE_ALL_BEANINFO)).getBeanInfo();</div><div class="line">    &#125;</div><div class="line">    ThreadGroupContext context = ThreadGroupContext.getContext();</div><div class="line">    BeanInfo beanInfo;</div><div class="line">    <span class="keyword">synchronized</span> (declaredMethodCache) &#123;</div><div class="line">    	<span class="comment">//一开始没有掉用过putBeanInfo，因此这里获取得到的为null</span></div><div class="line">        beanInfo = context.getBeanInfo(beanClass);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (beanInfo == <span class="keyword">null</span>) &#123;</div><div class="line">    	<span class="comment">//最终走到这一步，构造beanClass的内省器，然后从该内省器中获取BeanInfo</span></div><div class="line">        beanInfo = <span class="keyword">new</span> Introspector(beanClass, <span class="keyword">null</span>, USE_ALL_BEANINFO).getBeanInfo();</div><div class="line">        <span class="keyword">synchronized</span> (declaredMethodCache) &#123;</div><div class="line">            context.putBeanInfo(beanClass, beanInfo);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> beanInfo;</div><div class="line">&#125;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> BeanInfo <span class="title">getBeanInfo</span><span class="params">()</span> <span class="keyword">throws</span> IntrospectionException </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// the evaluation order here is import, as we evaluate the</span></div><div class="line">    <span class="comment">// event sets and locate PropertyChangeListeners before we</span></div><div class="line">    <span class="comment">// look for properties.</span></div><div class="line">    BeanDescriptor bd = getTargetBeanDescriptor();</div><div class="line">    MethodDescriptor mds[] = getTargetMethodInfo();</div><div class="line">    EventSetDescriptor esds[] = getTargetEventInfo();</div><div class="line">    <span class="comment">//这便是我们要找的PropertyDescriptor[]数组了，这个数组是什么时候写进来的呢？</span></div><div class="line">    PropertyDescriptor pds[] = getTargetPropertyInfo();</div><div class="line"></div><div class="line">    <span class="keyword">int</span> defaultEvent = getTargetDefaultEventIndex();</div><div class="line">    <span class="keyword">int</span> defaultProperty = getTargetDefaultPropertyIndex();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> GenericBeanInfo(bd, esds, defaultEvent, pds,</div><div class="line">                    defaultProperty, mds, explicitBeanInfo);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们来深入看getTargetPropertyInfo方法，这个方法比较长，需要细心的看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> PropertyDescriptor[] getTargetPropertyInfo() &#123;</div><div class="line"></div><div class="line">    <span class="comment">// Check if the bean has its own BeanInfo that will provide</span></div><div class="line">    <span class="comment">// explicit information.</span></div><div class="line">    PropertyDescriptor[] explicitProperties = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (explicitBeanInfo != <span class="keyword">null</span>) &#123;</div><div class="line">        explicitProperties = getPropertyDescriptors(<span class="keyword">this</span>.explicitBeanInfo);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (explicitProperties == <span class="keyword">null</span> &amp;&amp; superBeanInfo != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// We have no explicit BeanInfo properties.  Check with our parent.</span></div><div class="line">        addPropertyDescriptors(getPropertyDescriptors(<span class="keyword">this</span>.superBeanInfo));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; additionalBeanInfo.length; i++) &#123;</div><div class="line">        addPropertyDescriptors(additionalBeanInfo[i].getPropertyDescriptors());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (explicitProperties != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// Add the explicit BeanInfo data to our results.</span></div><div class="line">        addPropertyDescriptors(explicitProperties);</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line"></div><div class="line">    	<span class="comment">//对于前面的Device.class，explicitBeanInfo、explicitProperties、additionalBeanInfo都为null，所以直接走到这里</span></div><div class="line"></div><div class="line">        <span class="comment">// Apply some reflection to the current class.</span></div><div class="line"></div><div class="line">        <span class="comment">// First get an array of all the public methods at this level</span></div><div class="line">        Method methodList[] = getPublicDeclaredMethods(beanClass);</div><div class="line"></div><div class="line">        <span class="comment">//这里是重点了：获得BeanClass的所有public方法，然后依次分析</span></div><div class="line"></div><div class="line">        <span class="comment">// Now analyze each method.</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methodList.length; i++) &#123;</div><div class="line">            Method method = methodList[i];</div><div class="line">            <span class="keyword">if</span> (method == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// skip static methods.</span></div><div class="line">            <span class="keyword">int</span> mods = method.getModifiers();</div><div class="line">            <span class="keyword">if</span> (Modifier.isStatic(mods)) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            String name = method.getName();</div><div class="line">            Class&lt;?&gt;[] argTypes = method.getParameterTypes();</div><div class="line">            Class&lt;?&gt; resultType = method.getReturnType();</div><div class="line">            <span class="keyword">int</span> argCount = argTypes.length;</div><div class="line">            <span class="comment">//这便是我们PropertyDescriptor[]的单个元素 pd</span></div><div class="line">            PropertyDescriptor pd = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (name.length() &lt;= <span class="number">3</span> &amp;&amp; !name.startsWith(IS_PREFIX)) &#123;</div><div class="line">                <span class="comment">// Optimization. Don't bother with invalid propertyNames.</span></div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (argCount == <span class="number">0</span>) &#123;</div><div class="line">                	<span class="comment">//如果无参方法，则看下是否以get开头</span></div><div class="line">                    <span class="keyword">if</span> (name.startsWith(GET_PREFIX)) &#123;</div><div class="line">                        <span class="comment">// Simple getter</span></div><div class="line">                        pd = <span class="keyword">new</span> PropertyDescriptor(<span class="keyword">this</span>.beanClass, name.substring(<span class="number">3</span>), method, <span class="keyword">null</span>);</div><div class="line">                        <span class="comment">//看下方法返回类型是否为boolean、并且方法以is开头</span></div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resultType == <span class="keyword">boolean</span>.class &amp;&amp; name.startsWith(IS_PREFIX)) &#123;</div><div class="line">                        <span class="comment">// Boolean getter</span></div><div class="line">                        pd = <span class="keyword">new</span> PropertyDescriptor(<span class="keyword">this</span>.beanClass, name.substring(<span class="number">2</span>), method, <span class="keyword">null</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argCount == <span class="number">1</span>) &#123;</div><div class="line">                	<span class="comment">//如果有个参数，则看下是否以get开头，并且参数类型为int类型</span></div><div class="line">                    <span class="keyword">if</span> (<span class="keyword">int</span>.class.equals(argTypes[<span class="number">0</span>]) &amp;&amp; name.startsWith(GET_PREFIX)) &#123;</div><div class="line">                        pd = <span class="keyword">new</span> IndexedPropertyDescriptor(<span class="keyword">this</span>.beanClass, name.substring(<span class="number">3</span>), <span class="keyword">null</span>, <span class="keyword">null</span>, method, <span class="keyword">null</span>);</div><div class="line">                        <span class="comment">//看下方法释放以set开头，并且返回类型为void空类型</span></div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">void</span>.class.equals(resultType) &amp;&amp; name.startsWith(SET_PREFIX)) &#123;</div><div class="line">                        <span class="comment">// Simple setter</span></div><div class="line">                        pd = <span class="keyword">new</span> PropertyDescriptor(<span class="keyword">this</span>.beanClass, name.substring(<span class="number">3</span>), <span class="keyword">null</span>, method);</div><div class="line">                        <span class="keyword">if</span> (throwsException(method, PropertyVetoException.class)) &#123;</div><div class="line">                            pd.setConstrained(<span class="keyword">true</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argCount == <span class="number">2</span>) &#123;</div><div class="line">                		<span class="comment">//如果有两个参数，则检查1、返回类型释放为空， 第一个参数是否为int类型，然后方法开头是否以set开头</span></div><div class="line">                        <span class="keyword">if</span> (<span class="keyword">void</span>.class.equals(resultType) &amp;&amp; <span class="keyword">int</span>.class.equals(argTypes[<span class="number">0</span>]) &amp;&amp; name.startsWith(SET_PREFIX)) &#123;</div><div class="line">                        pd = <span class="keyword">new</span> IndexedPropertyDescriptor(<span class="keyword">this</span>.beanClass, name.substring(<span class="number">3</span>), <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, method);</div><div class="line">                        <span class="keyword">if</span> (throwsException(method, PropertyVetoException.class)) &#123;</div><div class="line">                            pd.setConstrained(<span class="keyword">true</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (IntrospectionException ex) &#123;</div><div class="line">                <span class="comment">// This happens if a PropertyDescriptor or IndexedPropertyDescriptor</span></div><div class="line">                <span class="comment">// constructor fins that the method violates details of the deisgn</span></div><div class="line">                <span class="comment">// pattern, e.g. by having an empty name, or a getter returning</span></div><div class="line">                <span class="comment">// void , or whatever.</span></div><div class="line">                pd = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//如果pd不为空，BeanClass的方法符合前面的条件，因此，将它通过addPropertyDescriptor方法添加到PropertyDescriptor列表中</span></div><div class="line">            <span class="keyword">if</span> (pd != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// If this class or one of its base classes is a PropertyChange</span></div><div class="line">                <span class="comment">// source, then we assume that any properties we discover are "bound".</span></div><div class="line">                <span class="keyword">if</span> (propertyChangeSource) &#123;</div><div class="line">                    pd.setBound(<span class="keyword">true</span>);</div><div class="line">                &#125;</div><div class="line">                addPropertyDescriptor(pd);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//将PropertyDescriptor从pdStore中取出来并处理，填充properties这个Map集合</span></div><div class="line">    processPropertyDescriptors();</div><div class="line"></div><div class="line">    <span class="comment">//最终，将处理过后的properties返回，这就是我们的结果</span></div><div class="line">    <span class="comment">// Allocate and populate the result array.</span></div><div class="line">    PropertyDescriptor result[] =</div><div class="line">            properties.values().toArray(<span class="keyword">new</span> PropertyDescriptor[properties.size()]);</div><div class="line"></div><div class="line">    <span class="comment">// Set the default index.</span></div><div class="line">    <span class="keyword">if</span> (defaultPropertyName != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; result.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (defaultPropertyName.equals(result[i].getName())) &#123;</div><div class="line">                defaultPropertyIndex = i;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个方法很长，但是最终我们找到了关键的地方getTargetPropertyInfo，因此，由于我们的Device类，所有元素都是public，并没有set/get/is/add之类的标准JavaBean所具有的方法，因此这里返回的PropertyDescriptor[]中只有一个Class元素，并不包含任何方法属性pd</p>
<p>从而导致 int[] columnToProperty = this.mapColumnsToProperties(rsmd, props); 这里，数组内容都是-1，即找不到属性<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">populateBean</span><span class="params">(ResultSet rs, T bean)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    PropertyDescriptor[] props = <span class="keyword">this</span>.propertyDescriptors(bean.getClass());</div><div class="line">    ResultSetMetaData rsmd = rs.getMetaData();</div><div class="line">    <span class="keyword">int</span>[] columnToProperty = <span class="keyword">this</span>.mapColumnsToProperties(rsmd, props);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> populateBean(rs, bean, props, columnToProperty);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>也就无法填充这个BeanClass的成员内容了，所以最终数据库QueryRunner查询出来的实例内容都是空的</p>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><p><a href="https://zh.wikipedia.org/wiki/JavaBeans" target="_blank" rel="external">https://zh.wikipedia.org/wiki/JavaBeans</a></p>
</div><div class="tags"><a href="/tags/源码阅读/">源码阅读</a><a href="/tags/Java/">Java</a></div><div class="post-nav"><a href="/2017/11/09/前端学习笔记_JavaScript学习(一)/" class="next">前端学习笔记_JavaScript学习（一）</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.molingyu.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/学习笔记/">学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/源码阅读/" style="font-size: 15px;">源码阅读</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/前端/" style="font-size: 15px;">前端</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/10/由DBUtils使用ResultHandler引出的一个关于JavaBean反射的问题/">由DBUtils使用ResultHandler引出的一个关于JavaBean反射的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/09/前端学习笔记_JavaScript学习(一)/">前端学习笔记_JavaScript学习（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/27/Android启动源码阅读(三)systemserver的启动过程/">Android启动源码阅读(三)systemserver进程的启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/27/Android启动源码阅读(二)zygote进程的启动/">Android启动源码阅读(二)zygote进程的启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/26/Android启动源码阅读(一)init进程的启动/">Android启动源码阅读(一)init进程的启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/25/Android源码阅读技巧/">Android源码阅读准备</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/18/一个epoll实例/">一个epoll实例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/17/本博客的建立/">本博客的建立</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/17/ReentrantLock/">ReentrantLock</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/JakeWharton" title="JakeWharton" target="_blank">JakeWharton</a><ul></ul><a href="https://github.com/Trinea" title="Trinea" target="_blank">Trinea</a><ul></ul><a href="http://blog.csdn.net/luoshengyang" title="罗升阳" target="_blank">罗升阳</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">子墨.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Maupassant</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>